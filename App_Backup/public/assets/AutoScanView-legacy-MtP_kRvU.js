System.register(["./index-legacy-DryGZUwD.js","./html5-qrcode-legacy-D5DtuMLO.js"],function(e,t){"use strict";var a,o,n,i,r,s,c,l,d,u,p,g,v,h,m,f,b,x,y,w,A,I,S,k,C,M,O;return{setters:[e=>{a=e.d,o=e.A,n=e.r,i=e.a6,r=e.a7,s=e.o,c=e.bR,l=e.j,d=e.b,u=e.i,p=e.t,g=e.e,v=e.u,h=e.cb,m=e.l,f=e.L,b=e.k,x=e.c,y=e.ba,w=e.c0,A=e.c1,I=e._,S=e.w,k=e.B,C=e.bC,M=e.y,O=e.cc},null],execute:function(){var t=document.createElement("style");t.textContent=".full-screen-scanner[data-v-a3ae227d]{position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000;background:#000}.camera-container[data-v-a3ae227d]{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}.camera-preview[data-v-a3ae227d]{width:100%;height:100%;object-fit:cover}.scanner-ui-overlay[data-v-a3ae227d]{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;display:flex;flex-direction:column;pointer-events:none}.top-controls[data-v-a3ae227d]{padding:calc(var(--ion-safe-area-top, 0px) + 16px) 20px 20px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,0,0,.6),rgba(0,0,0,0));pointer-events:auto}.scanner-title[data-v-a3ae227d]{color:#fff;font-weight:700;font-size:20px;text-shadow:0 2px 4px rgba(0,0,0,.5)}.close-btn[data-v-a3ae227d]{background:rgba(0,0,0,.5);border:none;border-radius:50%;width:40px;height:40px;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;backdrop-filter:blur(10px);pointer-events:auto}.scan-frame-container[data-v-a3ae227d]{flex:1;display:flex;align-items:center;justify-content:center}.scan-area[data-v-a3ae227d]{position:relative;width:85%;height:55%;border:1.5px solid rgba(255,255,255,.3);transition:all .4s cubic-bezier(.175,.885,.32,1.275)}.scan-area.detected[data-v-a3ae227d]{border-color:var(--ion-color-success);background:rgba(45,211,111,.1);transform:scale(1.05)}.corner[data-v-a3ae227d]{position:absolute;width:30px;height:30px;border:4px solid var(--ion-color-carrot)}.top-left[data-v-a3ae227d]{top:-2px;left:-2px;border-right:0;border-bottom:0;border-radius:4px 0 0}.top-right[data-v-a3ae227d]{top:-2px;right:-2px;border-left:0;border-bottom:0;border-radius:0 4px 0 0}.bottom-left[data-v-a3ae227d]{bottom:-2px;left:-2px;border-right:0;border-top:0;border-radius:0 0 0 4px}.bottom-right[data-v-a3ae227d]{bottom:-2px;right:-2px;border-left:0;border-top:0;border-radius:0 0 4px}.scan-area.detected .corner[data-v-a3ae227d]{border-color:var(--ion-color-success)}.hint-overlay[data-v-a3ae227d]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:85%;height:85%;object-fit:contain;opacity:.2;pointer-events:none;filter:grayscale(.5);transition:opacity .3s ease}.scan-line[data-v-a3ae227d]{position:absolute;top:0;left:0;width:100%;height:2px;background:var(--ion-color-carrot);box-shadow:0 0 15px var(--ion-color-carrot);animation:scan-a3ae227d 3s linear infinite}@keyframes scan-a3ae227d{0%{top:0;opacity:0}10%{opacity:1}90%{opacity:1}to{top:100%;opacity:0}}.bottom-controls[data-v-a3ae227d]{padding:20px 20px calc(var(--ion-safe-area-bottom, 0px) + 20px);display:flex;flex-direction:column;align-items:center;gap:16px;background:linear-gradient(to top,rgba(0,0,0,.6),rgba(0,0,0,0))}.status-badge[data-v-a3ae227d]{padding:12px 24px;border-radius:40px;background:rgba(0,0,0,.7);color:#fff;display:flex;align-items:center;gap:12px;font-size:16px;font-weight:600;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);box-shadow:0 4px 15px rgba(0,0,0,.3)}.status-scanning[data-v-a3ae227d]{border-color:var(--ion-color-carrot)}.status-detected[data-v-a3ae227d]{border-color:var(--ion-color-success);background:var(--ion-color-success)}.tips[data-v-a3ae227d]{color:rgba(255,255,255,.9);font-size:14px;text-align:center;width:85%;text-shadow:0 1px 2px rgba(0,0,0,.8);font-weight:500}ion-page[data-v-bce66075]{--background: #000}\n",document.head.appendChild(t);const z={class:"full-screen-scanner"},j={class:"camera-container"},R={class:"scanner-ui-overlay"},D={class:"top-controls"},P={class:"scanner-title"},_={class:"scan-frame-container"},T=["src"],H={key:1,class:"scan-line"},J={class:"bottom-controls"},N={class:"tips"},$=a({__name:"AutoScanCamera",props:{active:{type:Boolean}},emits:["detected","error","close"],setup(e,{emit:t}){const a=e,I=t,{t:S}=o(),k=n(null),C=n(null),M=n(!1),O=n(!1),$=n(S("scanIngredients.autoScan.status.init","Initializing HD Camera...")),L=n("/hints/hints1.png");let E=null,F=null;const B=i(()=>({"status-scanning":M.value&&!O.value,"status-detected":O.value,"status-idle":!M.value})),V=["ingredients","ingredient","æˆåˆ†","æˆä»½","é…æ–™","åŽŸæ–™","ææ–™","å…§å®¹ç‰©","å†…å®¹ç‰©"];async function initCamera(){if(!E){console.log("ðŸ“¸ [AutoScan] Requesting HD camera access..."),$.value=S("scanIngredients.autoScan.status.connecting","Connecting HD Camera...");try{E=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080},focusMode:"continuous"},audio:!1}),k.value&&(k.value.srcObject=E,k.value.setAttribute("autoplay",""),k.value.setAttribute("muted",""),k.value.setAttribute("playsinline",""),await k.value.play(),console.log(`âœ… [AutoScan] Video started: ${k.value.videoWidth}x${k.value.videoHeight}`),$.value=S("scanIngredients.autoScan.status.searching","Searching for ingredients..."),M.value=!0,async function startAnalysis(){F||(F=setInterval(async()=>{if(!M.value||O.value||!k.value||!C.value)return;const e=k.value,t=C.value,a=t.getContext("2d");if(a){t.width=1024,t.height=1024/e.videoWidth*e.videoHeight,a.drawImage(e,0,0,t.width,t.height);try{console.log("ðŸ” [AutoScan] AI Checking..."),$.value=S("scanIngredients.autoScan.status.scanning","AI Scanning...");const e=t.toDataURL("image/jpeg",.8).split(",")[1],a=await fetch("https://svmlwnzmheiishkdwafk.supabase.co/functions/v1/google-ocr",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2bWx3bnptaGVpaXNoa2R3YWZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNDk3OTUsImV4cCI6MjA2ODkyNTc5NX0.DQ5Xuq0F2x_5EJAMzUQreAWY9ecyTCd3mORl-Fo0Ydo","Content-Type":"application/json"},body:JSON.stringify({imageBase64:e,includeAnnotations:!0})}),n=await a.json();console.log("ðŸ“¦ [AutoScan] OCR Response keys:",JSON.stringify(Object.keys(n)));const i=(n.text||"").toLowerCase(),r=V.find(e=>i.includes(e));if(r){var o;console.log("ðŸŽ¯ [AutoScan] MATCH:",r);let e=null,a=n.textAnnotations||(null===(o=n.responses)||void 0===o||null===(o=o[0])||void 0===o?void 0:o.textAnnotations);if(!a&&n.words){console.log('ðŸ’¡ [AutoScan] mapping "words" to annotations format');const e=n.words[0];console.log("ðŸ“¦ [AutoScan] Sample word:",JSON.stringify(e));const t=n.words.map(e=>{let t=[];const a=e.boundingPoly||e.boundingBox;return a&&Array.isArray(a.vertices)?t=a.vertices:a&&"number"==typeof a.x?t=[{x:a.x,y:a.y},{x:a.x+a.w,y:a.y},{x:a.x+a.w,y:a.y+a.h},{x:a.x,y:a.y+a.h}]:Array.isArray(e.vertices)&&(t=e.vertices),{description:e.text||e.description||e.word||"",boundingPoly:{vertices:t}}});a=[{description:n.text||"",boundingPoly:{vertices:[]}},...t]}a?e=function calculateROI(e,t,a,o){try{console.log("ðŸ” [AutoScan] Attempting ROI for:",t,`on ${a}x${o}`);let i=e.find((e,a)=>a>0&&e.description&&e.description.toLowerCase().includes(t.toLowerCase()));if(!i||!i.boundingPoly){let a="",o=[];for(let t=1;t<e.length;t++){const n=e[t].description||"";a+=n;for(let a=0;a<n.length;a++)o.push(e[t])}const n=a.toLowerCase().indexOf(t.toLowerCase());-1!==n&&o[n]&&(i=o[n],console.log(`ðŸ’¡ [AutoScan] Fuzzy match successful for '${t}'. Mapped to block:`,i.description))}var n;if(!i||!i.boundingPoly)return console.warn(`âš ï¸ [AutoScan] Keyword match failed for '${t}' in textAnnotations blocks (total blocks: ${e.length})`),null!==(n=e[0])&&void 0!==n&&null!==(n=n.description)&&void 0!==n&&n.toLowerCase().includes(t.toLowerCase())&&console.log("ðŸ’¡ [AutoScan] Keyword found in block 0 only, using full image coordinates"),null;console.log("ðŸŽ¯ [AutoScan] Found target block:",i.description);const r=i.boundingPoly.vertices;let s=0,c=0;r.length>0&&(void 0!==r[0].x?(s=Math.min(...r.map(e=>{var t;return null!==(t=e.x)&&void 0!==t?t:0})),c=Math.min(...r.map(e=>{var t;return null!==(t=e.y)&&void 0!==t?t:0}))):"number"==typeof r[0]&&(s=r[0],c=r[1]));let l=s,d=s,u=c,p=c;for(let t=1;t<e.length;t++){const a=e[t].boundingPoly;if(!a||!a.vertices||0===a.vertices.length)continue;let o=0,n=0,i=0,r=0;const s=a.vertices;void 0!==s[0].x?(o=Math.min(...s.map(e=>{var t;return null!==(t=e.x)&&void 0!==t?t:0})),n=Math.max(...s.map(e=>{var t;return null!==(t=e.x)&&void 0!==t?t:0})),i=Math.min(...s.map(e=>{var t;return null!==(t=e.y)&&void 0!==t?t:0})),r=Math.max(...s.map(e=>{var t;return null!==(t=e.y)&&void 0!==t?t:0}))):"number"==typeof s[0]&&(s.length>=8?(o=Math.min(s[0],s[2],s[4],s[6]),n=Math.max(s[0],s[2],s[4],s[6]),i=Math.min(s[1],s[3],s[5],s[7]),r=Math.max(s[1],s[3],s[5],s[7])):(o=s[0],n=s[0],i=s[1],r=s[1])),r>=c-50&&(l=Math.min(l,o),d=Math.max(d,n),u=Math.min(u,i),p=Math.max(p,r))}const g=.05*a,v=.05*o;l=Math.max(0,l-g),u=Math.max(0,u-v),d=Math.min(a,d+g),p=Math.min(o,p+v);const h=l/a*100,m=u/o*100;let f=(d-l)/a*100,b=(p-u)/o*100;h+f>100&&(f=100-h),m+b>100&&(b=100-m);const x={left:h,top:m,width:f,height:b};return console.log("ðŸ“ [AutoScan] Dynamic text-bounded ROI:",x),x}catch(i){return console.error("âŒ [AutoScan] ROI calculation failed",i),null}}(a,r,t.width,t.height):console.warn("âš ï¸ [AutoScan] No annotations found for ROI. Keys:",Object.keys(n)),async function handleDetection(e=null){O.value=!0,$.value=S("scanIngredients.autoScan.status.found","Ingredients Found! Focusing..."),M.value=!1;try{await w.impact({style:A.Heavy}),setTimeout(async()=>{await w.impact({style:A.Heavy})},150)}catch(t){console.warn("âš ï¸ [AutoScan] Haptics failed",t)}if(await new Promise(e=>setTimeout(e,600)),k.value&&E){let a=null;try{const e=E.getVideoTracks()[0];if("ImageCapture"in window&&e){const t=new window.ImageCapture(e);a=await t.takePhoto()}}catch(t){console.warn("âš ï¸ [AutoScan] ImageCapture failed",t)}if(!a){const e=document.createElement("canvas");e.width=k.value.videoWidth,e.height=k.value.videoHeight;const t=e.getContext("2d");t&&(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(k.value,0,0),a=await new Promise(t=>e.toBlob(t,"image/jpeg",1)))}a&&I("detected",{blob:a,roi:e})}}(e)}else console.log("â³ [AutoScan] Ingredients not detected yet..."),$.value=S("scanIngredients.autoScan.status.notFound","Ingredients not found, keep holding...")}catch(n){console.warn("âš ï¸ [AutoScan] AI Analysis failed",n)}}},3500))}())}catch(e){console.error("âŒ [AutoScan] Camera access failed:",e),I("error","Could not access camera. Please check permissions.")}}}function stopCamera(){E&&(E.getTracks().forEach(e=>e.stop()),E=null),F&&(clearInterval(F),F=null),M.value=!1}return r(()=>a.active,e=>{e?initCamera():stopCamera()}),s(()=>{a.active&&initCamera();const e=Math.floor(5*Math.random())+1;L.value=`/hints/hints${e}.png`}),c(()=>{stopCamera()}),(e,t)=>(d(),l("div",z,[u("div",j,[u("video",{ref_key:"videoRef",ref:k,autoplay:"",playsinline:"",muted:"",class:"camera-preview"},null,512)]),u("div",R,[u("div",D,[u("span",P,"âœ¨ "+p(e.$t("scanIngredients.autoScan.title","Auto Scanner")),1),u("button",{class:"close-btn",onClick:t[0]||(t[0]=t=>e.$emit("close"))},[g(v(m),{icon:v(h)},null,8,["icon"])])]),u("div",_,[u("div",{class:f(["scan-area",{detected:O.value}])},[t[1]||(t[1]=u("div",{class:"corner top-left"},null,-1)),t[2]||(t[2]=u("div",{class:"corner top-right"},null,-1)),t[3]||(t[3]=u("div",{class:"corner bottom-left"},null,-1)),t[4]||(t[4]=u("div",{class:"corner bottom-right"},null,-1)),O.value?b("",!0):(d(),l("img",{key:0,src:L.value,class:"hint-overlay",alt:"Hint overlay"},null,8,T)),M.value?(d(),l("div",H)):b("",!0)],2)]),u("div",J,[u("div",{class:f(["status-badge",B.value])},[M.value&&!O.value?(d(),x(v(y),{key:0,name:"lines-small"})):b("",!0),u("span",null,p($.value),1)],2),u("div",N,p(e.$t("scanIngredients.autoScan.hint","Position ingredients inside the frame")),1)])]),u("canvas",{ref_key:"canvasRef",ref:C,style:{display:"none"}},null,512)]))}}),L=I($,[["__scopeId","data-v-a3ae227d"]]);e("default",I(a({__name:"AutoScanView",setup(e){const t=k(),{setResult:a}=O(),o=n("");function onDetected(e){a(e),t.back()}function onClose(){t.back()}function onError(e){o.value=e,setTimeout(()=>t.back(),2e3)}return(e,t)=>(d(),x(v(M),null,{default:S(()=>[g(L,{active:"",onDetected:onDetected,onClose:onClose,onError:onError}),g(v(C),{"is-open":!!o.value,message:o.value,duration:2e3,color:"danger",onDidDismiss:t[0]||(t[0]=e=>o.value="")},null,8,["is-open","message"])]),_:1}))}}),[["__scopeId","data-v-bce66075"]]))}}});
