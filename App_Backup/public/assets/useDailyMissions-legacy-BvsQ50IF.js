System.register(["./index-legacy-DryGZUwD.js"],function(e,i){"use strict";var t,r,a,n,d,c,s;return{setters:[e=>{t=e.a6,r=e.r,a=e.s,n=e.am,d=e.a2,c=e.a3,s=e.a4}],execute:function(){e("u",function useDailyMissions(){const{awardAndCelebrate:e}=n(),r=t(()=>i.value.every(e=>e.completed));return{missions:i,loading:o,claimedBonus:u,allCompleted:r,fetchProgress:async function fetchProgress(){o.value=!0;try{const{data:{user:t}}=await a.auth.getUser();if(!t)return;const r=d().tz("Asia/Taipei").startOf("day").toISOString(),n=d().tz("Asia/Taipei").endOf("day").toISOString(),{data:c,error:s}=await a.from("activity_log").select("activity_type, activity_detail").eq("user_id",t.id).gte("created_at",r).lt("created_at",n);if(s)return void console.warn("[Missions] activity_log query error:",s.message);i.value.forEach(e=>{e.current=0,e.completed=!1}),null==c||c.forEach(e=>{var t;let r=e.activity_detail;if("string"==typeof r)try{r=JSON.parse(r)}catch{r={}}switch(e.activity_type){case"scan_ingredients_success":const e=i.value.find(e=>"scan_ingredients"===e.id);if(e&&e.current<e.required&&e.current++,"Muslim-friendly"===(null===(t=r)||void 0===t?void 0:t.auto_status)){const e=i.value.find(e=>"find_muslim_friendly"===e.id);e&&e.current<e.required&&e.current++}break;case"explore_place_detail_open":const a=i.value.find(e=>"view_place_details"===e.id);a&&a.current<a.required&&a.current++;break;case"home_page_open":const n=i.value.find(e=>"open_app"===e.id);n&&n.current<n.required&&n.current++;break;case"barcode_scan_success":const d=i.value.find(e=>"scan_barcode"===e.id);d&&d.current<d.required&&d.current++;break;case"add_product_success":const c=i.value.find(e=>"add_product"===e.id);c&&c.current<c.required&&c.current++}});const{data:o,error:p}=await a.from("point_logs").select("action").eq("user_id",t.id).gte("created_at",r).lt("created_at",n),f=(null==o?void 0:o.map(e=>e.action))||[];i.value.forEach(i=>{const t=`mission_${i.id}`;l.value[i.id]=f.includes(t),"add_product"===i.id&&f.includes("add_product")&&(i.current=Math.max(i.current,1),l.value[i.id]=!0),i.current>=i.required&&(i.completed=!0,l.value[i.id]||_.has(i.id)||"add_product"===i.id||(console.log(`[Missions] Awarding points for: ${t}`),_.add(i.id),e(t).finally(()=>{setTimeout(()=>{_.delete(i.id)},5e3)}),l.value[i.id]=!0))}),u.value=f.includes("daily_mission_bonus")}catch(t){console.error("Error fetching mission progress:",t)}finally{o.value=!1}},checkAndAwardBonus:async function checkAndAwardBonus(){if(r.value&&!u.value&&!_.has("daily_bonus")){const{data:{user:i}}=await a.auth.getUser();if(!i)return;console.log("[Missions] Awarding daily bonus..."),_.add("daily_bonus"),await e("daily_mission_bonus").finally(()=>{setTimeout(()=>{_.delete("daily_bonus")},5e3)}),u.value=!0}}}}),d.extend(c),d.extend(s);const i=r([{id:"open_app",label:"Opening App",required:1,current:0,points:5,completed:!1,icon:"home-outline"},{id:"scan_ingredients",label:"Scan Ingredients",required:5,current:0,points:10,completed:!1,icon:"scan-outline"},{id:"scan_barcode",label:"Scan Barcode",required:5,current:0,points:10,completed:!1,icon:"barcode-outline"},{id:"find_muslim_friendly",label:"Find Muslim-friendly product",required:3,current:0,points:10,completed:!1,icon:"heart-outline"},{id:"view_place_details",label:"Check location details",required:1,current:0,points:5,completed:!1,icon:"location-outline"},{id:"add_product",label:"Add A New Product",required:1,current:0,points:10,completed:!1,icon:"add-circle-outline"}]),o=r(!1),u=r(!1),l=r({}),_=new Set}}});
