var e=Object.defineProperty,__publicField=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{r as t,s as a,z as s,d as i,A as o,B as l,o as n,C as r,c,b as d,u,D as h,w as m,e as p,i as f,E as v,p as g,t as y,F as _,j as b,k as w,G as k,H as x,J as M,l as j,K as T,L as C,M as $,n as P,N as L,O as S,P as D,Q as z,R as A,S as N,T as Y,U as O,V as H,W as q,X as B,m as R,Y as I,Z as U,$ as F,a0 as W,a1 as E,_ as J,a2 as Z,a3 as G,a4 as Q,a5 as V,a6 as X,a7 as K,a8 as ee,a as te,a9 as ae,aa as se,ab as ie,ac as oe,ad as le,ae as ne,af as re,ag as ce,ah as de,ai as ue,aj as he,ak as me,al as pe,y as fe}from"./index-D9IhqqAc.js";import{C as ve,p as ge,a as ye,b as _e,A as be,B as we,c as ke,L as xe,D as Me}from"./index-B4QOs9aT.js";import{u as je}from"./useDailyMissions-BrhXuVA9.js";import"./html5-qrcode-D_4nuB1t.js";function getLevelLabel(e){return"Level ".concat(s(e))}function getLevelColor(e){const t=s(e);return t<10?"medium":t<50?"primary":t<100?"success":"warning"}var Te={exports:{}};!function(e){class PrayTime{constructor(e){__publicField(this,"dtr",e=>e*Math.PI/180),__publicField(this,"rtd",e=>180*e/Math.PI),__publicField(this,"sin",e=>Math.sin(this.dtr(e))),__publicField(this,"cos",e=>Math.cos(this.dtr(e))),__publicField(this,"tan",e=>Math.tan(this.dtr(e))),__publicField(this,"arcsin",e=>this.rtd(Math.asin(e))),__publicField(this,"arccos",e=>this.rtd(Math.acos(e))),__publicField(this,"arctan",e=>this.rtd(Math.atan(e))),__publicField(this,"arccot",e=>this.rtd(Math.atan(1/e))),__publicField(this,"arctan2",(e,t)=>this.rtd(Math.atan2(e,t))),this.methods={MWL:{fajr:18,isha:17},ISNA:{fajr:15,isha:15},Egypt:{fajr:19.5,isha:17.5},Makkah:{fajr:18.5,isha:"90 min"},Karachi:{fajr:18,isha:18},Tehran:{fajr:17.7,maghrib:4.5,midnight:"Jafari"},Jafari:{fajr:16,maghrib:4,midnight:"Jafari"},France:{fajr:12,isha:12},Russia:{fajr:16,isha:15},Singapore:{fajr:20,isha:18},defaults:{isha:14,maghrib:"1 min",midnight:"Standard"}},this.settings={dhuhr:"0 min",asr:"Standard",highLats:"NightMiddle",tune:{},format:"24h",rounding:"nearest",utcOffset:"auto",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,location:[0,-(new Date).getTimezoneOffset()/4],iterations:1},this.labels=["Fajr","Sunrise","Dhuhr","Asr","Sunset","Maghrib","Isha","Midnight"],this.method(e||"MWL")}method(e){return this.set(this.methods.defaults).set(this.methods[e])}adjust(e){return this.set(e)}location(e){return this.set({location:e})}timezone(e){return this.set({timezone:e})}tune(e){return this.set({tune:e})}round(e="nearest"){return this.set({rounding:e})}format(e){return this.set({format:e})}set(e){return Object.assign(this.settings,e),this}utcOffset(e="auto"){return"number"==typeof e&&Math.abs(e)<16&&(e*=60),this.set({timezone:"UTC"}),this.set({utcOffset:e})}times(e=0){"number"==typeof e&&(e=new Date(e<1e3?Date.now()+864e5*e:e)),e.constructor===Date&&(e=[e.getFullYear(),e.getMonth()+1,e.getDate()]),this.utcTime=Date.UTC(e[0],e[1]-1,e[2]);let t=this.computeTimes();return this.formatTimes(t),t}getTimes(e,t,a="auto",s=0,i="24h"){if(!t)return this.times(e);const o="auto"==a?a:a+s;return this.location(t).utcOffset(o).format(i),this.times(e)}setMethod(e){this.method(e)}computeTimes(){let e={fajr:5,sunrise:6,dhuhr:12,asr:13,sunset:18,maghrib:18,isha:18,midnight:24};for(let t=0;t<this.settings.iterations;t++)e=this.processTimes(e);return this.adjustHighLats(e),this.updateTimes(e),this.tuneTimes(e),this.convertTimes(e),e}processTimes(e){const t=this.settings;return{fajr:this.angleTime(t.fajr,e.fajr,-1),sunrise:this.angleTime(.833,e.sunrise,-1),dhuhr:this.midDay(e.dhuhr),asr:this.angleTime(this.asrAngle(t.asr,e.asr),e.asr),sunset:this.angleTime(.833,e.sunset),maghrib:this.angleTime(t.maghrib,e.maghrib),isha:this.angleTime(t.isha,e.isha),midnight:this.midDay(e.midnight)+12}}updateTimes(e){const t=this.settings;if(this.isMin(t.maghrib)&&(e.maghrib=e.sunset+this.value(t.maghrib)/60),this.isMin(t.isha)&&(e.isha=e.maghrib+this.value(t.isha)/60),"Jafari"==t.midnight){const a=this.angleTime(t.fajr,29,-1)+24;e.midnight=(e.sunset+(this.adjusted?e.fajr+24:a))/2}e.dhuhr+=this.value(t.dhuhr)/60}tuneTimes(e){const t=this.settings.tune;for(let a in e)a in t&&(e[a]+=t[a]/60)}convertTimes(e){const t=this.settings.location[1];for(let a in e){const s=e[a]-t/15,i=this.utcTime+Math.floor(36e5*s);e[a]=this.roundTime(i)}}roundTime(e){const t={up:"ceil",down:"floor",nearest:"round"}[this.settings.rounding];if(!t)return e;return 6e4*Math[t](e/6e4)}sunPosition(e){const t=this.settings.location[1],a=this.utcTime/864e5-10957.5+this.value(e)/24-t/360,s=this.mod(357.529+.98560028*a,360),i=this.mod(280.459+.98564736*a,360),o=this.mod(i+1.915*this.sin(s)+.02*this.sin(2*s),360),l=23.439-36e-8*a,n=this.mod(this.arctan2(this.cos(l)*this.sin(o),this.cos(o))/15,24);return{declination:this.arcsin(this.sin(l)*this.sin(o)),equation:i/15-n}}midDay(e){const t=this.sunPosition(e).equation;return this.mod(12-t,24)}angleTime(e,t,a=1){const s=this.settings.location[0],i=this.sunPosition(t).declination,o=-this.sin(e)-this.sin(s)*this.sin(i),l=this.arccos(o/(this.cos(s)*this.cos(i)))/15;return this.midDay(t)+l*a}asrAngle(e,t){const a={Standard:1,Hanafi:2}[e]||this.value(e),s=this.settings.location[0],i=this.sunPosition(t).declination;return-this.arccot(a+this.tan(Math.abs(s-i)))}adjustHighLats(e){const t=this.settings;if("None"==t.highLats)return;this.adjusted=!1;const a=24+e.sunrise-e.sunset;Object.assign(e,{fajr:this.adjustTime(e.fajr,e.sunrise,t.fajr,a,-1),isha:this.adjustTime(e.isha,e.sunset,t.isha,a),maghrib:this.adjustTime(e.maghrib,e.sunset,t.maghrib,a)})}adjustTime(e,t,a,s,i=1){const o={NightMiddle:.5,OneSeventh:1/7,AngleBased:1/60*this.value(a)}[this.settings.highLats]*s,l=(e-t)*i;return(isNaN(e)||l>o)&&(e=t+o*i,this.adjusted=!0),e}formatTimes(e){for(let t in e)e[t]=this.formatTime(e[t])}formatTime(e){const t=this.settings.format;return isNaN(e)?"-----":"function"==typeof t?t(e):"x"==t.toLowerCase()?Math.floor(e/("X"==t?1e3:1)):this.timeToString(e,t)}timeToString(e,t){const a=this.settings.utcOffset,s=new Date(e+6e4*("auto"==a?0:a)).toLocaleTimeString("en-US",{timeZone:this.settings.timezone,hour12:"24h"!=t,hour:"24h"==t?"2-digit":"numeric",minute:"2-digit"});return"12H"==t?s.replace(/ ?[AP]M/,""):s}value(e){return+String(e).split(/[^0-9.+-]/)[0]}isMin(e){return-1!=String(e).indexOf("min")}mod(e,t){return(e%t+t)%t}}e.exports&&(e.exports={PrayTime:PrayTime})}(Te);var Ce=Te.exports;const $e={class:"card-header-row"},Pe={key:0,class:"red-dot"},Le={key:0,class:"discover-grid compact-grid"},Se={key:1,class:"completion-message fade-in",style:{"margin-top":"0"}},De={key:2,class:"discover-grid compact-grid"},ze={class:"mission-icon-container"},Ae={key:0,class:"pulse-ring"},Ne={class:"discover-name",style:{"margin-top":"3px","font-weight":"800"}},Ye={class:"discover-points"},Oe={class:"mission-icon-container"},He={key:0,class:"mission-progress-overlay"},qe={viewBox:"0 0 36 36",class:"mini-circular-chart"},Be={class:"discover-name",style:{"margin-top":"3px"}},Re={class:"discover-points"},Ie={class:"missions-vertical-list"},Ue=["onClick"],Fe={class:"v-mission-info"},We={class:"v-icon-wrap"},Ee={class:"v-text-wrap"},Je={class:"v-label"},Ze={class:"v-progress-text"},Ge={class:"v-points"},Qe={class:"v-mission-info"},Ve={class:"v-text-wrap"},Xe={class:"v-label"},Ke={class:"v-progress-text"},et={key:0},tt={key:1},at={key:2},st={class:"v-points"},it={key:0,class:"modal-completion-info"},ot=J(i({__name:"DailyMissions",setup(e){const a=t(!1),{t:s}=o(),{missions:i,loading:J,claimedBonus:Z,allCompleted:G,fetchProgress:Q,checkAndAwardBonus:V}=je(),X=l(),navigateToMission=e=>{switch(a.value=!1,e){case"open_app":X.push("/home");break;case"scan_ingredients":case"find_muslim_friendly":X.push("/scan");break;case"view_place_details":X.push("/explore");break;case"scan_barcode":X.push({path:"/search",query:{scan:"true"}});break;case"add_product":X.push("/add")}},getIcon=e=>{switch(e){case"scan-outline":return E;case"heart-outline":return W;case"location-outline":return F;case"barcode-outline":return U;case"add-circle-outline":return I;case"home-outline":return R;default:return $}};async function handleClaimBonus(){await V()}return n(()=>{Q()}),r(()=>{Q()}),(e,t)=>(d(),c(u(h),{class:"compact-section no-pointer"},{default:m(()=>[p(u(k),null,{default:m(()=>[f("div",$e,[p(u(v),null,{default:m(()=>[g(y(e.$t("dailyMissions.title")),1)]),_:1}),p(u(_),{fill:"clear",size:"small",color:"carrot",onClick:t[0]||(t[0]=e=>a.value=!0),class:"view-all-btn"},{default:m(()=>[g(y(e.$t("dailyMissions.viewAll"))+" ",1),u(Z)?w("",!0):(d(),b("div",Pe))]),_:1})])]),_:1}),p(u(L),null,{default:m(()=>[u(J)?(d(),b("div",Le,[(d(),b(x,null,M(3,e=>p(u(h),{key:"mission-skel-"+e,class:"discover-item discover-item--compact"},{default:m(()=>[p(u(q),{animated:"",style:{width:"100%",height:"70px","border-radius":"10px"}}),p(u(q),{animated:"",style:{width:"80%",height:"14px",margin:"6px auto"}})]),_:2},1024)),64))])):u(G)&&u(Z)?(d(),b("div",Se,[p(u(j),{icon:u(T),color:"success"},null,8,["icon"]),f("p",null,y(e.$t("dailyMissions.allCompletedMsg")),1)])):(d(),b("div",De,[u(G)?(d(),c(u(h),{key:0,class:C(["discover-item","discover-item--compact","bonus-dashboard-card",{"is-claimed":u(Z)}]),button:"",onClick:handleClaimBonus},{default:m(()=>[f("div",ze,[p(u(j),{icon:u($),color:u(Z)?"success":"warning"},null,8,["icon","color"]),u(Z)?w("",!0):(d(),b("div",Ae))]),p(u(P),{class:"discover-label discover-label--compact"},{default:m(()=>[f("p",Ne,y(u(Z)?e.$t("dailyMissions.bonusClaimed"):e.$t("dailyMissions.claimBonus")),1),f("p",Ye,y(e.$t("dailyMissions.bonusPoints",{label:e.$t("dailyMissions.xp")})),1)]),_:1})]),_:1},8,["class"])):w("",!0),(d(!0),b(x,null,M(u(i),a=>(d(),c(u(h),{key:a.id,class:C(["discover-item","discover-item--compact",{"mission-completed-border":a.completed}]),button:"",onClick:e=>navigateToMission(a.id)},{default:m(()=>[f("div",Oe,[p(u(j),{icon:getIcon(a.icon),color:a.completed?"success":"medium"},null,8,["icon","color"]),a.completed?w("",!0):(d(),b("div",He,[(d(),b("svg",qe,[t[3]||(t[3]=f("path",{class:"circle-bg",d:"M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"},null,-1)),f("path",{class:"circle",style:B({strokeDasharray:Math.min(100,a.current/a.required*100)+", 100"}),d:"M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"},null,4)]))]))]),p(u(P),{class:"discover-label discover-label--compact"},{default:m(()=>[f("p",Be,y(e.$t("dailyMissions.missions."+a.id)),1),f("p",Re,y(a.current)+"/"+y(a.required)+" â€¢ +"+y(a.points)+" "+y(e.$t("dailyMissions.xp")),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]))]),_:1}),p(u(H),{"is-open":a.value,onDidDismiss:t[2]||(t[2]=e=>a.value=!1),"initial-breakpoint":.75,breakpoints:[0,.75,1]},{default:m(()=>[p(u(S),null,{default:m(()=>[p(u(D),null,{default:m(()=>[p(u(z),null,{default:m(()=>[g(y(e.$t("dailyMissions.title")),1)]),_:1}),p(u(A),{slot:"end"},{default:m(()=>[p(u(_),{onClick:t[1]||(t[1]=e=>a.value=!1)},{default:m(()=>[g(y(e.$t("dailyMissions.close")),1)]),_:1})]),_:1})]),_:1})]),_:1}),p(u(N),{class:"ion-padding"},{default:m(()=>[f("div",Ie,[(d(!0),b(x,null,M(u(i),t=>(d(),b("div",{key:t.id,class:C(["v-mission-item",{completed:t.completed}]),onClick:e=>navigateToMission(t.id),style:{cursor:"pointer"}},[f("div",Fe,[f("div",We,[p(u(j),{icon:getIcon(t.icon),color:t.completed?"success":"medium"},null,8,["icon","color"])]),f("div",Ee,[f("div",Je,y(e.$t("dailyMissions.missions."+t.id)),1),f("div",Ze,y(t.current)+" / "+y(t.required)+" "+y(e.$t("dailyMissions.completed")),1)]),f("div",Ge,"+"+y(t.points)+" "+y(e.$t("dailyMissions.xp")),1)]),p(u(O),{value:t.current/t.required,color:t.completed?"success":"carrot"},null,8,["value","color"])],10,Ue))),128)),f("div",{class:C(["v-mission-item bonus-item",{completed:u(Z),"can-claim":u(G)&&!u(Z)}]),onClick:handleClaimBonus,style:{cursor:"pointer"}},[f("div",Qe,[f("div",{class:C(["v-icon-wrap",{"pulse-bg":u(G)&&!u(Z)}])},[p(u(j),{icon:u(Y),color:u(Z)?"success":u(G)?"carrot":"medium"},null,8,["icon","color"])],2),f("div",Ve,[f("div",Xe,y(e.$t("dailyMissions.dailyBonus")),1),f("div",Ke,[u(Z)?(d(),b("span",et,y(e.$t("dailyMissions.alreadyClaimed")),1)):u(G)?(d(),b("span",tt,y(e.$t("dailyMissions.claimXpBonus")),1)):(d(),b("span",at,y(e.$t("dailyMissions.dailyBonusDesc")),1))])]),f("div",st,"+50 "+y(e.$t("dailyMissions.xp")),1)]),p(u(O),{value:u(Z)||u(G)?1:u(i).filter(e=>e.completed).length/u(i).length,color:u(Z)||u(G)?"success":"carrot"},null,8,["value","color"])],2),u(G)&&u(Z)?(d(),b("div",it,[f("p",null,y(e.$t("dailyMissions.masteryAchieved")),1),f("small",null,y(e.$t("dailyMissions.comeBackTomorrow")),1)])):w("",!0)])]),_:1})]),_:1},8,["is-open"])]),_:1}))}}),[["__scopeId","data-v-5668c9ed"]]),lt={class:"prayer-header-row"},nt={class:"prayer-title-main"},rt={class:"prayer-title-location"},ct={key:0,class:"prayer-horizontal"},dt={key:1,class:"qibla-row"},ut={class:"prayer-track"},ht=["data-key"],mt={class:"label"},pt={class:"time"},ft={class:"scan-row"},vt={class:"scan-row"},gt={class:"card-header-row"},yt={key:0,class:"discover-grid compact-grid"},_t={key:1,class:"discover-grid compact-grid"},bt=["src","alt"],wt={class:"discover-name"},kt={class:"card-header-row"},xt={key:0,class:"discover-grid"},Mt={key:1,class:"discover-grid"},jt=["src","alt"],Tt={class:"card-header-row"},Ct={key:0,class:"discover-grid"},$t={key:1,class:"discover-grid"},Pt=["src","alt"],Lt={class:"card-header-row"},St={key:0,class:"discover-grid"},Dt={key:1,class:"discover-grid"},zt=["src","alt"],At={class:"discover-name"},Nt={style:{"font-size":"12px",color:"var(--ion-color-medium)"}},Yt={class:"chart-flex"},Ot={class:"chart-flex"},Ht={style:{display:"flex","align-items":"center",width:"100%"}},qt={style:{width:"28px","text-align":"center","font-weight":"600"}},Bt={key:0},Rt={key:1},It={key:2},Ut={key:3},Ft=["src","alt"],Wt={style:{margin:"0","font-weight":"600","font-size":"1rem","white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"}},Et={style:{margin:"0","font-size":"0.8rem",color:"var(--ion-color-medium)"}},Jt={key:0},Zt=["src","alt"],Gt={style:{"margin-top":"6px","font-size":"1rem"}},Qt={style:{margin:"4px 0","font-size":"0.85rem",color:"var(--ion-color-medium)"}},Vt={key:0,style:{"margin-top":"6px","font-size":"0.8rem",color:"var(--ion-color-dark)"}},Xt={style:{margin:"4px 0","font-size":"0.9rem","font-weight":"600"}},Kt={style:{margin:"4px 0","font-size":"0.85rem",color:"var(--ion-color-medium)"}},ea=J(i({__name:"HomeView",setup(e){let s=null;const i=t(null),T=t(null);ve.register(ge,ye,_e,be,we,ke,xe);const $=Me,D=l(),{t:z}=o(),{fetchProgress:A}=je(),Y=t(null),O=t(null),H=t(!0),B=t(!0),R=t(!0),I=t([]),W=t([]),J=t(!0),Te=t([]),$e=t(null),{leaderboard:Pe,loading:Le,fetchLeaderboard:Se}=function useLeaderboard(){const e=t([]),s=t(!1),i=t(null);return{leaderboard:e,loading:s,error:i,fetchLeaderboard:async function fetchLeaderboard(t=10){s.value=!0,i.value=null;const{data:o,error:l}=await a.from("user_profiles").select("id, display_name, avatar_url, points, donor_type, public_leaderboard, bio").gt("points",0).order("points",{ascending:!1}).limit(t);!l&&o&&(e.value=o.map((e,t)=>({...e,display_name:e.public_leaderboard?e.display_name:"Anonymous #".concat(t+1),avatar_url:e.public_leaderboard?e.avatar_url:"https://placehold.co/64x64"}))),l?(console.error("âŒ Error fetching leaderboard:",l),i.value=l.message,e.value=[]):e.value=null!=o?o:[],s.value=!1}}}(),De=t(!1),ze={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",align:"center",labels:{color:getComputedStyle(document.documentElement).getPropertyValue("--ion-color-dark").trim(),boxWidth:14,font:{size:12},padding:8}}}},Ae=t({labels:["Halal","Muslim-friendly","Syubhah","Haram"],datasets:[{backgroundColor:["#28a745","#007bff","#ffc107","#dc3545"],data:[0,0,0,0]}]}),Ne=t({labels:[],datasets:[{backgroundColor:["#3498db","#2ecc71","#f1c40f","#e74c3c","#9b59b6","#1abc9c","#e67e22"],data:[]}]}),Ye=t([]),Oe=t(!0),He=t(null),qe=t(!0),Be=t(null);Z.extend(G),Z.extend(Q),Z.extend(V);const Re=t(Z.tz.guess());function fromNowToTaipei(e){return e?Z.utc(e).tz(Re.value).fromNow():""}const Ie=t(Z().tz(Re.value));async function fetchRecentNews(){J.value=!0;const{data:e,error:t}=await a.from("news").select("id, title, header_image, created_at").order("created_at",{ascending:!1}).limit(15);!t&&e&&(Te.value=e.map(e=>({id:e.id,title:e.title,cover:e.header_image||"https://placehold.co/400x250?text=News",created_at:e.created_at}))),J.value=!1}const Ue={gold:3,silver:2,bronze:1},Fe=X(()=>[...Ye.value].sort((e,t)=>(Ue[t.partner_tier]||0)-(Ue[e.partner_tier]||0)));async function fetchPrayerTimes(){qe.value=!0;const e=await async function getUserLocation(){var e,t,a,s;const i=localStorage.getItem("hf_user_location");if(i){const e=JSON.parse(i);return $e.value=e,e}try{let i,l;if(ae.isNativePlatform()){if("granted"!==(await ie.requestPermissions()).location)throw new Error("Location permission denied");const e=await ie.getCurrentPosition({enableHighAccuracy:!0});i=e.coords.latitude,l=e.coords.longitude}else{const e=await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t)});i=e.coords.latitude,l=e.coords.longitude}let n=z("home.currentLocation");try{const o=await fetch("https://nominatim.openstreetmap.org/reverse?format=json&lat=".concat(i,"&lon=").concat(l),{headers:{Accept:"application/json","User-Agent":"HalalFormosaApp/1.0"}});console.log("Reverse status:",o.status);const r=await o.json();n=(null==(e=r.address)?void 0:e.city)||(null==(t=r.address)?void 0:t.town)||(null==(a=r.address)?void 0:a.municipality)||(null==(s=r.address)?void 0:s.state)||z("home.currentLocation")}catch(o){console.warn("[Reverse Geocode Failed]",o)}return $e.value={lat:i,lng:l,city:n},localStorage.setItem("hf_user_location",JSON.stringify($e.value)),$e.value}catch(l){return console.warn("[GPS] Using fallback Taipei"),$e.value={lat:25.033,lng:121.5654,city:z("home.taipei")},$e.value}}(),t=new Ce.PrayTime("MWL");t.location([e.lat,e.lng]).timezone(Re.value).format("24h").adjust({highLats:"AngleBased"});const a=t.getTimes(new Date);He.value={fajr:a.fajr,sunrise:a.sunrise,dhuhr:a.dhuhr,asr:a.asr,maghrib:a.maghrib,isha:a.isha},qe.value=!1}const We=X(()=>He.value?[{key:"fajr",label:z("home.prayers.fajr"),time:He.value.fajr},{key:"dhuhr",label:z("home.prayers.dhuhr"),time:He.value.dhuhr},{key:"asr",label:z("home.prayers.asr"),time:He.value.asr},{key:"maghrib",label:z("home.prayers.maghrib"),time:He.value.maghrib},{key:"isha",label:z("home.prayers.isha"),time:He.value.isha}]:[]),Ee=X(()=>{if(!He.value)return null;const e=Ie.value,t=e.format("YYYY-MM-DD"),a=We.value.map(e=>({...e,timeObj:Z.tz("".concat(t," ").concat(e.time),"YYYY-MM-DD HH:mm",Re.value)}));for(let s=0;s<a.length;s++){const t=a[s],i=a[s+1];if(i){if(e.isAfter(t.timeObj)&&e.isBefore(i.timeObj))return t.key}else if(e.isAfter(t.timeObj))return t.key}return"isha"}),Je=X(()=>{if(!He.value)return null;const e=Ie.value;for(const a of We.value){const t=Z.tz("".concat(e.format("YYYY-MM-DD")," ").concat(a.time),"YYYY-MM-DD HH:mm",Re.value);if(t.isAfter(e))return{...a,timeObj:t}}const t=Z.tz("".concat(e.add(1,"day").format("YYYY-MM-DD")," ").concat(He.value.fajr),"YYYY-MM-DD HH:mm",Re.value);return{key:"fajr",label:z("home.prayers.fajr"),time:He.value.fajr,timeObj:t}}),Ze=X(()=>Ee.value);K(()=>Ze.value,async e=>{e&&(await oe(),requestAnimationFrame(()=>{const t=Be.value;if(!t)return;const a=t.querySelector('.prayer-pill[data-key="'.concat(e,'"]'));if(!a)return;const s=a.offsetLeft-t.clientWidth/2+a.clientWidth/2;t.scrollTo({left:s,behavior:"smooth"})}))},{immediate:!0});const Ge=X(()=>{if(!Je.value)return"";const e=Je.value.timeObj.diff(Ie.value,"second");if(e<=0)return"00:00:00";return[Math.floor(e/3600),Math.floor(e%3600/60),e%60].map(e=>String(e).padStart(2,"0")).join(":")});function closePopover(){i.value=null,T.value=null}async function fetchRecentProducts(){B.value=!0;const{data:e,error:t}=await a.from("products").select("barcode, name, status, photo_front_url, created_at, product_categories(name)").eq("approved",!0).order("created_at",{ascending:!1}).limit(15);!t&&e&&(I.value=e.map(e=>{var t,a;return{barcode:e.barcode,name:e.name,status:e.status,category:(null==(a=null==(t=e.product_categories)?void 0:t[0])?void 0:a.name)||"",image:e.photo_front_url,created_at:e.created_at}})),B.value=!1}async function fetchRecentLocations(){R.value=!0;const{data:e,error:t}=await a.from("locations").select("id, name, image, type_id, location_types(name), created_at").eq("approved",!0).order("created_at",{ascending:!1}).limit(15);!t&&e&&(W.value=e.map(e=>{var t,a;return{id:e.id,name:e.name,image:e.image,type:(null==(a=null==(t=e.location_types)?void 0:t[0])?void 0:a.name)||"",created_at:e.created_at}})),R.value=!1}async function fetchStats(){H.value=!0;const{data:e}=await a.from("products").select("status, created_at");if(e){const t={Halal:0,"Muslim-friendly":0,Syubhah:0,Haram:0};e.forEach(e=>{void 0!==t[e.status]&&t[e.status]++}),function updateChartSmoothly(e,t){oe(()=>{var a;if(!(null==(a=e.value)?void 0:a.chart))return;const s=e.value.chart;s.data.datasets[0].data=t,s.update("active")})}(Y,Object.values(t))}H.value=!1}async function fetchLocationCategoryStats(){const{data:e,error:t}=await a.from("locations").select("\n    id,\n    name,\n    image,\n    created_at,\n    location_types!inner ( name )\n  ").eq("approved",!0);if(!t&&e){const t={};null==e||e.forEach(e=>{var a;const s=(null==(a=e.location_types)?void 0:a.name)||z("home.unknown");t[s]=(t[s]||0)+1});const a=Object.keys(t),s=Object.values(t);Ne.value={labels:a,datasets:[{backgroundColor:["#3498db","#2ecc71","#e67e22","#9b59b6","#f1c40f","#e74c3c","#1abc9c"],data:s}]}}}async function fetchHomePartners(){Oe.value=!0;const{data:e,error:t}=await a.from("partners").select("\n    id,\n    name,\n    logo_url,\n    partner_tier\n  ").eq("is_active",!0).order("partner_tier",{ascending:!1}).limit(6);if(t)return console.error("[Home Partners]",t),void(Oe.value=!1);Ye.value=(null!=e?e:[]).map(e=>({id:e.id,name:e.name,partner_tier:e.partner_tier,logo:e.logo_url||"https://placehold.co/300x300?text=".concat(encodeURIComponent(e.name))})),Oe.value=!1}async function refreshAllData(){console.log("ðŸ  [Home] Refreshing all data...");const e=[fetchStats(),fetchLocationCategoryStats(),fetchRecentProducts(),fetchRecentLocations(),fetchRecentNews(),Se(),fetchHomePartners()];De.value&&e.push(A()),await Promise.allSettled(e),ae.isNativePlatform()&&se()}function goScan(){ee.log("home_scan_ingredient"),D.push("/scan")}function goToSearchAndScan(){ee.log("home_scan_barcode"),D.push({path:"/search",query:{scan:"true"}})}function goQibla(){ee.log("home_find_qibla_click"),D.push({path:"/qibla",query:{from:"home"}})}function viewMorePartners(){ee.log("home_viewmore_partners"),D.push("/partners")}function viewMoreProducts(){ee.log("home_viewmore_products"),D.push("/search")}function viewMoreLocations(){ee.log("home_viewmore_locations"),D.push("/explore")}function viewMoreNews(){ee.log("home_viewmore_news"),D.push("/news")}return r(async()=>{ee.log("home_page_open");const{data:e}=await a.auth.getSession();De.value=!!e.session,refreshAllData(),fetchPrayerTimes(),function startClock(){s=window.setInterval(()=>{Ie.value=Z().tz(Re.value)},1e3)}()}),n(()=>{refreshAllData()}),te(()=>{s&&(clearInterval(s),s=null)}),(e,t)=>(d(),c(u(fe),null,{default:m(()=>[p(u(S),null,{default:m(()=>[p(le,{title:e.$t("home.title"),showProfile:!0},null,8,["title"])]),_:1}),p(u(N),{class:"ion-padding"},{default:m(()=>[p(u(ne),{slot:"fixed",onIonRefresh:t[0]||(t[0]=e=>async function handleRefresh(e){await refreshAllData(),e.target.complete()}(e))},{default:m(()=>[p(u(re))]),_:1}),p(u(h),{class:"prayer-card"},{default:m(()=>[p(u(k),null,{default:m(()=>[f("div",lt,[p(u(v),null,{default:m(()=>[Je.value&&$e.value?(d(),b(x,{key:0},[f("div",nt,y(e.$t("home.prayerNotification",{label:Je.value.label,time:Ge.value})),1),f("div",rt,[p(u(j),{icon:u(F),slot:"start"},null,8,["icon"]),g(" "+y($e.value.city||e.$t("home.currentLocation")),1)])],64)):(d(),b(x,{key:1},[g(y(e.$t("home.prayerTimes")),1)],64))]),_:1}),p(u(_),{size:"small",fill:"outline",color:"carrot",class:"qibla-header-btn",onClick:goQibla},{default:m(()=>[g(" ðŸ§­ "+y(e.$t("home.qibla")),1)]),_:1})])]),_:1}),p(u(L),null,{default:m(()=>[qe.value?(d(),b("div",ct,[(d(),b(x,null,M(5,e=>f("div",{key:"prayer-skel-"+e,class:"prayer-pill skeleton"},[p(u(q),{animated:"",style:{width:"50%",height:"12px","border-radius":"6px"}}),p(u(q),{animated:"",style:{width:"70%",height:"22px","margin-top":"6px","border-radius":"6px"}})])),64))])):w("",!0),qe.value?(d(),b("div",dt,[p(u(q),{animated:"",style:{width:"110px",height:"28px","border-radius":"999px"}})])):(d(),b("div",{key:2,class:"prayer-horizontal",ref_key:"prayerScroll",ref:Be},[f("div",ut,[(d(!0),b(x,null,M(We.value,e=>(d(),b("div",{key:e.key,"data-key":e.key,class:C(["prayer-pill",e.key===Ee.value?"active":""])},[f("span",mt,y(e.label),1),f("span",pt,y(e.time),1)],10,ht))),128))])],512))]),_:1})]),_:1}),p(u(h),{class:"featured-card no-pointer"},{default:m(()=>[p(u(k),null,{default:m(()=>[p(u(v),null,{default:m(()=>[g(y(e.$t("home.mainFeature")),1)]),_:1})]),_:1}),p(u(L),null,{default:m(()=>[f("div",ft,[p(u(_),{expand:"block",color:"carrot",onClick:goScan},{default:m(()=>[p(u(j),{icon:u(E),slot:"start"},null,8,["icon"]),g(" "+y(e.$t("home.scan")),1)]),_:1})]),f("div",vt,[p(u(_),{expand:"block",color:"carrot",onClick:goToSearchAndScan},{default:m(()=>[p(u(j),{icon:u(U),slot:"start"},null,8,["icon"]),g(" "+y(e.$t("home.scanBarcode")),1)]),_:1})])]),_:1})]),_:1}),p(u(h),{class:"compact-section no-pointer"},{default:m(()=>[p(u(k),null,{default:m(()=>[f("div",gt,[p(u(v),null,{default:m(()=>[g(y(e.$t("home.ourPartners")),1)]),_:1}),p(u(_),{fill:"clear",size:"small",color:"carrot",onClick:viewMorePartners},{default:m(()=>[g(y(e.$t("home.viewMore")),1)]),_:1})])]),_:1}),p(u(L),null,{default:m(()=>[Oe.value?(d(),b("div",yt,[(d(),b(x,null,M(5,e=>p(u(h),{key:"partner-skel-"+e,class:"discover-item discover-item--compact"},{default:m(()=>[p(u(q),{animated:"",style:{width:"100%",height:"120px","border-radius":"12px"}}),p(u(q),{animated:"",style:{width:"80%",height:"14px",margin:"6px auto"}})]),_:2},1024)),64))])):(d(),b("div",_t,[(d(!0),b(x,null,M(Fe.value,t=>(d(),c(u(h),{key:t.id,class:C(["discover-item","discover-item--compact",t.partner_tier]),button:"",onClick:e=>function openPartner(e){ee.log("home_partner_click",{id:e.id,name:e.name}),D.push("/partner/".concat(e.id))}(t)},{default:m(()=>[t.partner_tier?(d(),c(u(ce),{key:0,class:C(["tier-badge",t.partner_tier])},{default:m(()=>[g(y(e.$t("home.partnerTier",{tier:t.partner_tier.toUpperCase()})),1)]),_:2},1032,["class"])):w("",!0),f("img",{src:t.logo,alt:t.name,class:"discover-img discover-img--compact"},null,8,bt),p(u(P),{class:"discover-label discover-label--compact"},{default:m(()=>[f("p",wt,y(t.name),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]))]),_:1})]),_:1}),De.value?(d(),c(ot,{key:0})):w("",!0),p(u(h),{class:"no-pointer"},{default:m(()=>[p(u(k),null,{default:m(()=>[f("div",kt,[p(u(v),null,{default:m(()=>[g(y(e.$t("home.discoverProducts")),1)]),_:1}),p(u(_),{fill:"clear",size:"small",color:"carrot",onClick:viewMoreProducts},{default:m(()=>[g(y(e.$t("home.viewMore")),1)]),_:1})])]),_:1}),p(u(L),null,{default:m(()=>[B.value?(d(),b("div",xt,[(d(),b(x,null,M(5,e=>p(u(h),{key:"skeleton-p-"+e,class:"discover-item"},{default:m(()=>[p(u(q),{animated:"",style:{width:"100%",height:"140px","border-radius":"12px"}}),p(u(q),{animated:"",style:{width:"95%",height:"30px",margin:"6px auto"}}),p(u(q),{animated:"",style:{width:"40%",height:"12px",margin:"0 auto"}})]),_:2},1024)),64))])):(d(),b("div",Mt,[(d(!0),b(x,null,M(I.value,t=>(d(),c(u(h),{key:t.barcode,class:"discover-item",button:"",onClick:e=>async function openProduct(e){ee.log("home_product_click",{barcode:e.barcode,name:e.name,status:e.status}),D.push("/item/".concat(e.barcode))}(t)},{default:m(()=>[f("img",{src:t.image||"https://placehold.co/200x200",alt:e.$t("home.altProduct"),class:"discover-img"},null,8,jt),p(u(P),{class:"discover-label"},{default:m(()=>[p(u(de),{class:C("Halal"===t.status?"chip-success":"Muslim-friendly"===t.status?"chip-primary":"Syubhah"===t.status?"chip-warning":"Haram"===t.status?"chip-danger":"chip-medium"),style:{"font-size":"14px","margin-bottom":"4px"}},{default:m(()=>[g(y(t.status),1)]),_:2},1032,["class"]),f("p",null,y(e.$t("home.added"))+" "+y(fromNowToTaipei(t.created_at)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]))]),_:1})]),_:1}),p(u(h),{class:"no-pointer"},{default:m(()=>[p(u(k),null,{default:m(()=>[f("div",Tt,[p(u(v),null,{default:m(()=>[g(y(e.$t("home.discoverLocations")),1)]),_:1}),p(u(_),{fill:"clear",size:"small",color:"carrot",onClick:viewMoreLocations},{default:m(()=>[g(y(e.$t("home.viewMore")),1)]),_:1})])]),_:1}),p(u(L),null,{default:m(()=>[R.value?(d(),b("div",Ct,[(d(),b(x,null,M(5,e=>p(u(h),{key:"skeleton-l-"+e,class:"discover-item"},{default:m(()=>[p(u(q),{animated:"",style:{width:"100%",height:"140px","border-radius":"12px"}}),p(u(q),{animated:"",style:{width:"90%",height:"12px",margin:"6px auto"}}),p(u(q),{animated:"",style:{width:"80%",height:"12px",margin:"6px auto"}}),p(u(q),{animated:"",style:{width:"40%",height:"12px",margin:"0 auto"}})]),_:2},1024)),64))])):(d(),b("div",$t,[(d(!0),b(x,null,M(W.value,t=>(d(),c(u(h),{key:t.id,class:"discover-item",button:"",onClick:e=>async function openLocation(e){ee.log("home_location_click",{id:e.id,name:e.name,type:e.type}),D.push("/place/".concat(e.id))}(t)},{default:m(()=>[f("img",{src:t.image||"https://placehold.co/200x200",alt:e.$t("home.altLocation"),class:"discover-img"},null,8,Pt),p(u(P),{class:"discover-label"},{default:m(()=>[f("h3",null,y(t.name),1),f("p",null,y(e.$t("home.added"))+" "+y(fromNowToTaipei(t.created_at)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]))]),_:1})]),_:1}),p(u(h),{class:"no-pointer"},{default:m(()=>[p(u(k),null,{default:m(()=>[f("div",Lt,[p(u(v),null,{default:m(()=>[g(y(e.$t("home.latestNews")),1)]),_:1}),p(u(_),{fill:"clear",size:"small",color:"carrot",onClick:viewMoreNews},{default:m(()=>[g(y(e.$t("home.viewMore")),1)]),_:1})])]),_:1}),p(u(L),null,{default:m(()=>[J.value?(d(),b("div",St,[(d(),b(x,null,M(5,e=>p(u(h),{key:"news-skeleton-"+e,class:"discover-item"},{default:m(()=>[p(u(q),{animated:"",style:{width:"100%",height:"140px","border-radius":"12px"}}),p(u(q),{animated:"",style:{width:"90%",height:"14px",margin:"6px auto"}}),p(u(q),{animated:"",style:{width:"60%",height:"12px",margin:"0 auto"}})]),_:2},1024)),64))])):(d(),b("div",Dt,[(d(!0),b(x,null,M(Te.value,t=>(d(),c(u(h),{key:t.id,class:"discover-item",style:{height:"210px"},button:"",onClick:e=>function openNews(e){ee.log("home_news_click",{id:e.id,title:e.title}),D.push("/news/".concat(e.id))}(t)},{default:m(()=>[f("img",{src:t.cover||"https://placehold.co/400x250?text=News",class:"discover-img",alt:e.$t("home.altNews")},null,8,zt),p(u(P),{class:"discover-label"},{default:m(()=>[f("h3",At,y(t.title),1),f("p",Nt,y(fromNowToTaipei(t.created_at)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]))]),_:1})]),_:1}),p(u(h),null,{default:m(()=>[p(u(k),null,{default:m(()=>[p(u(v),null,{default:m(()=>[g(y(e.$t("home.productStatus")),1)]),_:1})]),_:1}),f("div",Yt,[p(u($),{ref_key:"doughnutRef",ref:Y,data:Ae.value,options:ze},null,8,["data"])])]),_:1}),p(u(h),null,{default:m(()=>[p(u(k),null,{default:m(()=>[p(u(v),null,{default:m(()=>[g(y(e.$t("home.locationCategories")),1)]),_:1})]),_:1}),f("div",Ot,[p(u($),{ref_key:"locationChartRef",ref:O,data:Ne.value,options:ze},null,8,["data"])])]),_:1}),p(u(h),null,{default:m(()=>[p(u(k),null,{default:m(()=>[p(u(v),null,{default:m(()=>[g(y(e.$t("home.leaderboard")),1)]),_:1})]),_:1}),p(u(L),null,{default:m(()=>[u(Le)?(d(),c(u(q),{key:1,animated:"",style:{width:"100%",height:"120px","border-radius":"8px"}})):(d(),c(u(ue),{key:0},{default:m(()=>[(d(!0),b(x,null,M(u(Pe),(t,a)=>(d(),c(u(he),{key:t.id,lines:"none",button:"",onClick:e=>function openUserProfile(e,t){ee.log("home_leaderboard_profile",{user_id:e.id,display_name:e.display_name}),i.value=e,T.value=t}(t,e)},{default:m(()=>[f("div",Ht,[f("div",qt,[0===a?(d(),b("span",Bt,"ðŸ¥‡")):1===a?(d(),b("span",Rt,"ðŸ¥ˆ")):2===a?(d(),b("span",It,"ðŸ¥‰")):(d(),b("span",Ut,y(a+1),1))]),p(u(me),{style:{width:"40px",height:"40px",margin:"0 10px"}},{default:m(()=>[f("img",{src:t.public_leaderboard?t.avatar_url||"https://placehold.co/64x64":"https://placehold.co/64x64?text=".concat(e.$t("home.unknownAvatar")),alt:e.$t("home.altAvatar")},null,8,Ft)]),_:2},1024),p(u(P),{style:{flex:"1","min-width":"0"}},{default:m(()=>[f("h2",Wt,y(t.public_leaderboard?t.display_name:e.$t("home.anonymousWithIndex",{index:a+1})),1),f("p",Et,y(u(getLevelLabel)(t.points)),1)]),_:2},1024),p(u(ce),{color:u(getLevelColor)(t.points),style:{"white-space":"nowrap","font-size":"0.75rem","min-width":"70px","text-align":"center"}},{default:m(()=>[g(y(e.$t("home.pointsCount",{points:t.points})),1)]),_:2},1032,["color"])])]),_:2},1032,["onClick"]))),128))]),_:1}))]),_:1})]),_:1})]),_:1}),p(u(pe),{"is-open":!!i.value,event:T.value,onDidDismiss:closePopover},{default:m(()=>[p(u(N),{class:"ion-padding",style:{"text-align":"center","min-width":"220px"}},{default:m(()=>[i.value?(d(),b("div",Jt,[i.value.public_leaderboard?(d(),b(x,{key:0},[p(u(me),{style:{width:"60px",height:"60px",margin:"auto"}},{default:m(()=>[f("img",{src:i.value.avatar_url||"https://placehold.co/60x60?text=?",alt:e.$t("home.altAvatar")},null,8,Zt)]),_:1}),f("h3",Gt,y(i.value.display_name),1),f("p",Qt,y(u(getLevelLabel)(i.value.points))+" ("+y(e.$t("home.pointsCount",{points:i.value.points}))+") ",1),i.value.bio?(d(),b("p",Vt,y(i.value.bio),1)):w("",!0)],64)):(d(),b(x,{key:1},[f("p",Xt,y(e.$t("home.anonymous")),1),f("p",Kt,y(u(getLevelLabel)(i.value.points))+" ("+y(e.$t("home.pointsCount",{points:i.value.points}))+") ",1)],64))])):w("",!0)]),_:1})]),_:1},8,["is-open","event"])]),_:1}))}}),[["__scopeId","data-v-3a235bac"]]);export{ea as default};
