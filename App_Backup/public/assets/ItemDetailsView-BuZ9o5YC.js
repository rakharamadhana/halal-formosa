import{d as e,r as a,bm as l,a9 as t,a2 as o,a3 as r,a4 as n,a5 as s,a6 as i,bH as c,o as u,s as d,a8 as p,ac as m,c as v,w as g,u as _,b as f,e as h,j as y,k as b,O as w,ad as k,bI as x,aj as C,l as P,bJ as M,aP as I,n as D,p as F,aJ as q,bn as T,S as E,i as S,W as $,H as j,J as H,bp as L,bq as R,br as N,t as z,Z as A,ah as U,L as V,bK as O,bL as B,F as J,V as K,D as W,by as Y,bB as Z,bd as G,ai as X,bM as Q,bc as ee,bC as ae,y as le,bb as te,bN as oe,aW as re,aX as ne,aa as se}from"./index-D9IhqqAc.js";import{Z as ie}from"./zoom-oVw40Yze.js";import ce from"./AddProductView-C2VHLXuL.js";import"./html5-qrcode-D_4nuB1t.js";import"./useNotifier-BmoHZOF2.js";const ue={key:0},de={class:"ion-padding-horizontal"},pe={style:{"margin-top":"8px"}},me={key:1},ve=["src"],ge=["src"],_e={style:{"margin-top":"1rem","padding-top":"0"},class:"ion-padding"},fe={style:{"margin-bottom":"0"}},he={style:{"margin-top":"3px","margin-bottom":"0",display:"flex","align-items":"center","justify-content":"space-between"}},ye={style:{display:"flex","align-items":"center",gap:"6px"}},be={style:{"margin-top":"10px"}},we={key:0,class:"ion-margin-top"},ke=["onClick"],xe={class:"gold-cert-content"},Ce={class:"gold-cert-left"},Pe=["src"],Me={class:"gold-cert-text"},Ie={class:"gold-cert-name"},De={key:1,class:"ion-margin-top"},Fe={class:"ion-margin-top"},qe=["innerHTML"],Te={class:"ion-margin-top"},Ee={style:{margin:"0","padding-left":"1.2rem"}},Se=["innerHTML"],$e={key:2,class:"ion-margin-top"},je={key:3,class:"ion-margin-top ingredient-legend"},He={key:4},Le={class:"card-header-row",style:{"margin-top":"10px"}},Re={class:"discover-grid"},Ne=["src"],ze={key:2,class:"ion-text-center ion-margin-top"},Ae={class:"swiper-zoom-container"},Ue=["src"],Ve={class:"swiper-zoom-container"},Oe=["src"],Be={key:0,class:"ion-text-center ion-padding"},Je=e({__name:"ItemDetailsView",setup(e){const Je=a(!1),Ke=l().params.barcode,We=a(!0),Ye=a(t.isNativePlatform()),Ze=[R,ie],Ge=a(!1),Xe=a({}),Qe=a(!1),ea=a([]),aa=a(!1),la=a(""),ta=a(0),oa=a(!1),ra=a(!1),na=a(!1),sa=a(""),ia=a([]),ca=a(!1),ua=a(null),da=a(!1),pa=a(0),ma=a([]),va={"--ion-color-danger":1,"--ion-color-warning":2,"--ion-color-primary":3,"--ion-color-success":4,none:5};function getColorFromHtml(e){const a=e.match(/var\((--ion-color-[^)]+)\)/);return a?a[1]:"none"}async function openSaveModal(){if(!aa.value&&!te.value&&ta.value>=10){await p.log("pro_paywall_trigger",{source:"save_item_limit"});if(!(await async function presentPaywall(){if(!t.isNativePlatform())return console.warn("[RC] Paywall can only run on native."),!1;try{const{result:e}=await re.presentPaywall();switch(e){case ne.PURCHASED:case ne.RESTORED:return await se({syncToServer:!0}),await p.log("pro_purchase_success",{source:"save_item_limit"}),!0;case ne.CANCELLED:case ne.ERROR:default:return!1}}catch(e){return console.error("Paywall failed:",e),!1}}()))return;await new Promise(e=>setTimeout(e,300))}Qe.value=!0}async function createNewFolder(){if(!la.value.trim()||!_a.value)return;const{data:e,error:a}=await d.from("saved_item_folders").insert({user_id:_a.value,name:la.value.trim()}).select().single();e&&!a&&(ea.value.unshift(e),la.value="",await saveToFolder(e.id))}async function saveToFolder(e){if(!_a.value||!ua.value)return;const{data:a}=await d.from("saved_items").select("id").eq("user_id",_a.value).eq("folder_id",e).eq("product_id",ua.value.id).maybeSingle();if(a)return aa.value=!0,Qe.value=!1,sa.value="This item is already saved in this folder.",void(ra.value=!0);const{error:l}=await d.from("saved_items").insert({user_id:_a.value,folder_id:e,product_id:ua.value.id});l&&"23505"!==l.code?(console.error("Failed to save",l),sa.value="Failed to save item. Please try again.",na.value=!0):(aa.value=!0,Qe.value=!1,"23505"===(null==l?void 0:l.code)?(sa.value="This item is already saved in this folder.",ra.value=!0):(sa.value="Item saved successfully!",oa.value=!0))}function openImageModal(e){ua.value&&p.log("product_image_open",{barcode:ua.value.barcode,product_name:ua.value.name,image:0===e?"front":"back"}),pa.value=e,da.value=!0}function closeImageModal(){da.value=!1}o.extend(r),o.extend(n),o.extend(s);const ga=i(()=>!!ua.value&&(!!["admin","contributor"].includes(c.value||"")||_a.value&&ua.value.added_by===_a.value)),_a=a(null);function editItem(){ua.value&&p.log("product_edit_click",{barcode:ua.value.barcode,product_name:ua.value.name}),Je.value=!0}function reportItem(){ua.value&&(p.log("product_report_click",{barcode:ua.value.barcode,product_name:ua.value.name}),oe.push({name:"report",params:{barcode:ua.value.barcode}}))}function closeEditModal(){Je.value=!1}async function handleProductUpdated(){var e;Je.value=!1;const{data:a,error:l}=await d.from("products").select("\n    *,\n    product_categories ( id, name ),\n    product_stores (\n      store_id,\n      stores ( id, name, logo_url )\n    )\n  ").eq("barcode",Ke).maybeSingle();!l&&a&&(ua.value={...a,stores:(null==(e=a.product_stores)?void 0:e.map(e=>e.stores))||[]})}const fa=i(()=>ha.value?Ge.value?ha.value:ha.value.slice(0,5):[]),ha=i(()=>ua.value&&ua.value.ingredients?"Halal"===ua.value.status?ua.value.ingredients.split(",").map(e=>({html:e.trim(),highlighted:!1})).filter(e=>e.html.length>0):function highlightIngredients(e,a,l){const t=e.split(",").map(e=>e.trim()).filter(Boolean),o=Object.keys(a).sort((e,a)=>a.length-e.length);return t.map(e=>{let t=null;for(const a of o){let l;if(/[|()[\]\\]/.test(a))try{l=new RegExp(a,"i")}catch(r){continue}else{const e=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");l=new RegExp("\\b".concat(e,"\\b"),"i")}if(l.test(e)){t=a;break}}if(t){let o=a[t];return"Muslim-friendly"===l&&"--ion-color-warning"===o&&(o="--ion-color-primary"),{html:'<span style="color:var('.concat(o,');font-weight:600">').concat(e,"</span>"),highlighted:!0}}return{html:e,highlighted:!1}})}(ua.value.ingredients,Xe.value,ua.value.status).sort((e,a)=>{const l=getColorFromHtml(e.html),t=getColorFromHtml(a.html);return va[l]-va[t]}):[]),ya=i(()=>{var e;if(!ha.value)return[];if("Halal"===(null==(e=ua.value)?void 0:e.status))return[];const a=new Set;return ha.value.forEach(e=>{if(e.highlighted){const l=e.html.match(/var\((--ion-color-[^)]+)\)/);l&&a.add(l[1])}}),Array.from(a)}),ba=i(()=>{var e;if(!(null==(e=ua.value)?void 0:e.description))return"";const a={halal:"--ion-color-success","muslim-friendly":"--ion-color-primary",vegan:"--ion-color-primary",syubhah:"--ion-color-warning"};let l=ua.value.description;for(const[t,o]of Object.entries(a)){const e=new RegExp("(".concat(t,")"),"gi");l=l.replace(e,'<span style="font-weight:600; color: var('.concat(o,');">$1</span>'))}return l}),wa={"--ion-color-success":"search.details.legend.halal","--ion-color-primary":"search.details.legend.muslimFriendly","--ion-color-warning":"search.details.legend.syubhah","--ion-color-danger":"search.details.legend.haram"};function colorToChipClass(e){switch(e){case"--ion-color-success":return"chip-success";case"--ion-color-primary":return"chip-primary";case"--ion-color-warning":return"chip-warning";case"--ion-color-danger":return"chip-danger";default:return"chip-medium"}}return u(async()=>{var e,a,l;We.value=!0;try{const[{data:{user:l}},t,o]=await Promise.all([d.auth.getUser(),d.from("products").select("\n          *,\n          product_categories ( id, name ),\n          product_stores (\n            store_id,\n            stores ( id, name, logo_url )\n          )\n        ").eq("barcode",Ke).maybeSingle(),d.from("ingredient_highlights").select("keyword, color")]);if(l&&(_a.value=l.id),t.error)console.error("Product load error:",t.error);else if(t.data){const l={...t.data,stores:(null==(e=t.data.product_stores)?void 0:e.map(e=>{var a;return{id:e.stores.id,name:e.stores.name,logo_url:null!=(a=e.stores.logo_url)?a:void 0}}))||[]};ua.value=l,l.id&&await async function fetchProductCertifications(e){ca.value=!0;const{data:a,error:l}=await d.from("product_certifications").select("\n      certified_at,\n      partners (\n        id,\n        name,\n        logo_url,\n        partner_tier,\n        verified\n      )\n    ").eq("product_id",e).eq("status","active");!l&&a&&(ia.value=a.filter(e=>e.partner&&"gold"===e.partner.partner_tier).map(e=>({certified_at:e.certified_at,partner:e.partner}))),ca.value=!1}(l.id),await p.log("product_details_open",{barcode:l.barcode,product_name:l.name,status:l.status,category:(null==(a=l.product_categories)?void 0:a.name)||null}),await async function fetchRelatedProducts(){var e;if(!(null==(e=ua.value)?void 0:e.product_category_id))return;const a=ua.value.name.split(" ")[0].toLowerCase(),{data:l,error:t}=await d.from("products").select("barcode, name, status, photo_front_url, product_category_id, created_at").eq("approved",!0).eq("product_category_id",ua.value.product_category_id).neq("barcode",ua.value.barcode).order("created_at",{ascending:!1}).limit(100);if(!t&&l){const e=l,t=[...e.filter(e=>e.name.toLowerCase().includes(a)),...e.filter(e=>!e.name.toLowerCase().includes(a))].slice(0,15);ma.value=Array.from(new Map(t.map(e=>[e.barcode,e])).values())}}(),await async function loadFoldersAndSavedState(){if(!_a.value||!ua.value)return;const{data:e}=await d.from("saved_item_folders").select("id, name").eq("user_id",_a.value).order("created_at",{ascending:!1});e&&(ea.value=e);const{data:a}=await d.from("saved_items").select("id").eq("user_id",_a.value).eq("product_id",ua.value.id);aa.value=!!(a&&a.length>0);const{count:l}=await d.from("saved_items").select("*",{count:"exact",head:!0}).eq("user_id",_a.value);ta.value=l||0}()}o.error?console.error("Highlights load error:",o.error):o.data&&(Xe.value=Object.fromEntries(o.data.map(e=>[e.keyword,e.color])))}finally{We.value=!1,await m(),null==(l=window.scheduleBannerUpdate)||l.call(window)}}),(e,a)=>(f(),v(_(le),null,{default:g(()=>[h(_(w),null,{default:g(()=>[h(k,{title:e.$t("search.details.title"),"show-back":"","back-route":"/search",icon:_(x)},{actions:g(()=>[_a.value?(f(),v(_(C),{key:0,button:"",onClick:openSaveModal,lines:"none"},{default:g(()=>[h(_(P),{icon:aa.value?_(M):_(I),slot:"start"},null,8,["icon"]),h(_(D),null,{default:g(()=>a[8]||(a[8]=[F("Save",-1)])),_:1,__:[8]})]),_:1})):b("",!0),ga.value?(f(),v(_(C),{key:1,button:"",onClick:editItem,lines:"none"},{default:g(()=>[h(_(P),{icon:_(q),slot:"start"},null,8,["icon"]),h(_(D),null,{default:g(()=>a[9]||(a[9]=[F("Edit",-1)])),_:1,__:[9]})]),_:1})):b("",!0),h(_(C),{button:"",onClick:reportItem,lines:"none"},{default:g(()=>[h(_(P),{icon:_(T),slot:"start"},null,8,["icon"]),h(_(D),null,{default:g(()=>a[10]||(a[10]=[F("Report",-1)])),_:1,__:[10]})]),_:1})]),_:1},8,["title","icon"])]),_:1}),(Ye.value,b("",!0)),h(_(E),null,{default:g(()=>{var l,t;return[We.value?(f(),y("div",ue,[h(_($),{animated:"",style:{width:"100%",height:"300px"}}),S("div",de,[h(_($),{animated:"",style:{width:"70%",height:"22px","margin-top":"16px"}}),h(_($),{animated:"",style:{width:"40%",height:"16px","margin-top":"8px"}}),h(_($),{animated:"",style:{width:"100%",height:"40px","border-radius":"5px","margin-top":"16px"}}),h(_($),{animated:"",style:{width:"50%",height:"16px","margin-top":"20px"}}),h(_($),{animated:"",style:{width:"90%",height:"14px","margin-top":"8px"}}),h(_($),{animated:"",style:{width:"85%",height:"14px","margin-top":"4px"}}),h(_($),{animated:"",style:{width:"60%",height:"16px","margin-top":"20px"}}),S("div",pe,[(f(),y(j,null,H(4,e=>h(_($),{key:e,animated:"",style:{width:"90%",height:"14px","margin-bottom":"6px"}})),64))]),h(_($),{animated:"",style:{width:"100%",height:"44px","border-radius":"4px","margin-top":"12px"}})])])):ua.value?(f(),y("div",me,[ua.value.photo_front_url||ua.value.photo_back_url?(f(),v(_(L),{key:0,modules:Ze,scrollbar:!0,"slides-per-view":1,pagination:{clickable:!0},class:"product-swiper"},{default:g(()=>[ua.value.photo_front_url?(f(),v(_(N),{key:0},{default:g(()=>[S("img",{src:ua.value.photo_front_url,alt:"Front Image",style:{width:"100%",height:"100%","object-fit":"cover",cursor:"pointer"},onClick:a[0]||(a[0]=e=>openImageModal(0))},null,8,ve)]),_:1})):b("",!0),ua.value.photo_back_url?(f(),v(_(N),{key:1},{default:g(()=>[S("img",{src:ua.value.photo_back_url,alt:"Back Image",style:{width:"100%",height:"100%","object-fit":"cover",cursor:"pointer"},onClick:a[1]||(a[1]=e=>openImageModal(1))},null,8,ge)]),_:1})):b("",!0)]),_:1})):b("",!0),S("div",_e,[S("h2",fe,z(ua.value.name),1),S("p",he,[S("span",ye,[h(_(P),{icon:_(A),style:{"font-size":"18px"}},null,8,["icon"]),S("small",null,z(ua.value.barcode),1)]),S("small",null,z(null==(l=ua.value.product_categories)?void 0:l.name),1)]),S("p",be,[h(_(U),{class:V(_(O)(ua.value.status))},{default:g(()=>[F(z(e.$t("search.status.".concat(ua.value.status))),1)]),_:1},8,["class"])]),!ca.value&&ia.value.length?(f(),y("div",we,[a[13]||(a[13]=S("p",null,[S("strong",null,[S("small",null,"Certified by")])],-1)),(f(!0),y(j,null,H(ia.value,e=>(f(),y("div",{key:e.partner.id,class:"gold-cert-card",role:"button",tabindex:"0",onClick:a=>function goToPartner(e){p.log("partner_click",{partner_id:e,source:"product_detail"}),oe.push("/partner/".concat(e))}(e.partner.id)},[a[12]||(a[12]=S("div",{class:"gold-glow"},null,-1)),S("div",xe,[S("div",Ce,[e.partner.logo_url?(f(),y("img",{key:0,src:e.partner.logo_url,alt:"logo",class:"gold-cert-logo"},null,8,Pe)):b("",!0),S("div",Me,[S("div",Ie,z(e.partner.name),1),a[11]||(a[11]=S("div",{class:"gold-cert-sub"}," Gold Partner · Verified ",-1))])])])],8,ke))),128))])):b("",!0),(null==(t=ua.value.stores)?void 0:t.length)?(f(),y("div",De,[S("p",null,[S("strong",null,[S("small",null,z(e.$t("search.details.availableAt")),1)])]),h(B,{stores:ua.value.stores,mode:"readonly"},null,8,["stores"])])):b("",!0),S("p",Fe,[S("strong",null,[S("small",null,z(e.$t("search.details.description")),1)])]),S("h5",{class:"ion-no-margin",style:{"margin-top":"2px"},innerHTML:ba.value},null,8,qe),S("p",Te,[S("strong",null,[S("small",null,z(e.$t("search.details.ingredients")),1)])]),S("ul",Ee,[(f(!0),y(j,null,H(fa.value,(e,a)=>(f(),y("li",{key:a,innerHTML:e.html},null,8,Se))),128))]),ha.value.length>5?(f(),y("div",$e,[h(_(J),{fill:"clear",size:"small",onClick:a[2]||(a[2]=e=>Ge.value=!Ge.value)},{default:g(()=>[F(z(Ge.value?e.$t("search.details.viewLess"):e.$t("search.details.viewMore")),1)]),_:1})])):b("",!0),ya.value.length?(f(),y("div",je,[S("p",null,[S("strong",null,[S("small",null,z(e.$t("search.details.colorLegend")),1)])]),(f(!0),y(j,null,H(ya.value,a=>(f(),v(_(U),{key:a,class:V(colorToChipClass(a))},{default:g(()=>[F(z(e.$t(wa[a])),1)]),_:2},1032,["class"]))),128))])):b("",!0),h(_(K),{"is-open":Je.value,onDidDismiss:closeEditModal},{default:g(()=>[h(ce,{"edit-product":ua.value,onClose:closeEditModal,onUpdated:handleProductUpdated},null,8,["edit-product"])]),_:1},8,["is-open"]),ma.value.length?(f(),y("div",He,[S("div",Le,[S("strong",null,[S("small",null,z(e.$t("search.details.relatedProducts")),1)])]),S("div",Re,[(f(!0),y(j,null,H(ma.value,e=>(f(),v(_(W),{key:e.barcode,class:"discover-item",button:"",onClick:a=>function openRelated(e){ua.value&&p.log("related_product_click",{from_barcode:ua.value.barcode,from_name:ua.value.name,clicked_barcode:e.barcode,clicked_name:e.name}),oe.replace("/item/".concat(e.barcode))}(e)},{default:g(()=>[S("img",{src:e.photo_front_url||"https://placehold.co/200x200",alt:"product",class:"discover-img"},null,8,Ne),h(_(D),{class:"discover-label"},{default:g(()=>{return[h(_(U),{class:V(_(O)(e.status)),style:{"font-size":"14px","margin-bottom":"4px"}},{default:g(()=>[F(z(e.status),1)]),_:2},1032,["class"]),S("h3",null,z(e.name),1),S("p",null,"Added "+z((a=e.created_at,a?o.utc(a).tz("Asia/Taipei").fromNow():"")),1)];var a}),_:2},1024)]),_:2},1032,["onClick"]))),128))])])):b("",!0)])])):(f(),y("p",ze,"❌ "+z(e.$t("search.details.no-item")),1))]}),_:1}),h(_(K),{"is-open":da.value,onDidDismiss:closeImageModal},{default:g(()=>[h(_(E),{fullscreen:""},{default:g(()=>[h(_(J),{fill:"solid",color:"carrot",class:"image-modal-close-btn",onClick:closeImageModal},{default:g(()=>a[14]||(a[14]=[F(" ✕ ",-1)])),_:1,__:[14]}),h(_(L),{modules:[_(R),_(ie)],zoom:!0,"slides-per-view":1,pagination:{clickable:!0},"initial-slide":pa.value,class:"fullscreen-swiper"},{default:g(()=>[ua.value.photo_front_url?(f(),v(_(N),{key:0},{default:g(()=>[S("div",Ae,[S("img",{src:ua.value.photo_front_url,alt:"Front Image"},null,8,Ue)])]),_:1})):b("",!0),ua.value.photo_back_url?(f(),v(_(N),{key:1},{default:g(()=>[S("div",Ve,[S("img",{src:ua.value.photo_back_url,alt:"Back Image"},null,8,Oe)])]),_:1})):b("",!0)]),_:1},8,["modules","initial-slide"])]),_:1})]),_:1},8,["is-open"]),h(_(K),{"is-open":Qe.value,onDidDismiss:a[4]||(a[4]=e=>Qe.value=!1),"initial-breakpoint":.5,breakpoints:[0,.5,.75]},{default:g(()=>[h(_(E),{class:"ion-padding"},{default:g(()=>[a[16]||(a[16]=S("h3",null,"Save to Folder",-1)),h(_(C),{lines:"full"},{default:g(()=>[h(_(Y),{modelValue:la.value,"onUpdate:modelValue":a[3]||(a[3]=e=>la.value=e),placeholder:"New collection name...",onKeyup:Z(createNewFolder,["enter"])},null,8,["modelValue"]),h(_(J),{fill:"clear",slot:"end",onClick:createNewFolder},{default:g(()=>[h(_(P),{icon:_(G)},null,8,["icon"])]),_:1})]),_:1}),h(_(X),{class:"ion-margin-top"},{default:g(()=>[h(_(Q),null,{default:g(()=>a[15]||(a[15]=[F("Your Collections",-1)])),_:1,__:[15]}),(f(!0),y(j,null,H(ea.value,e=>(f(),v(_(C),{key:e.id,button:"",onClick:a=>saveToFolder(e.id)},{default:g(()=>[h(_(P),{icon:_(ee),slot:"start"},null,8,["icon"]),h(_(D),null,{default:g(()=>[F(z(e.name),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),0===ea.value.length?(f(),y("p",Be,"You haven't created any folders yet.")):b("",!0)]),_:1})]),_:1,__:[16]})]),_:1},8,["is-open"]),h(_(ae),{"is-open":oa.value,message:sa.value,duration:2e3,color:"success",position:"bottom",onDidDismiss:a[5]||(a[5]=e=>oa.value=!1)},null,8,["is-open","message"]),h(_(ae),{"is-open":ra.value,message:sa.value,duration:2e3,color:"warning",position:"bottom",onDidDismiss:a[6]||(a[6]=e=>ra.value=!1)},null,8,["is-open","message"]),h(_(ae),{"is-open":na.value,message:sa.value,duration:2e3,color:"danger",position:"bottom",onDidDismiss:a[7]||(a[7]=e=>na.value=!1)},null,8,["is-open","message"])]),_:1}))}});export{Je as default};
