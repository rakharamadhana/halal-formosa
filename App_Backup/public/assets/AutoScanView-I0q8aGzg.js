import{d as e,A as t,r as n,a6 as a,a7 as o,o as s,bR as i,j as c,b as l,i as r,t as u,e as d,u as v,cb as g,l as m,L as h,k as p,c as y,ba as f,c0 as w,c1 as b,_ as A,w as I,B as S,bC as x,y as C,cc as k}from"./index-D9IhqqAc.js";import"./html5-qrcode-D_4nuB1t.js";const M={class:"full-screen-scanner"},O={class:"camera-container"},R={class:"scanner-ui-overlay"},D={class:"top-controls"},P={class:"scanner-title"},_={class:"scan-frame-container"},j=["src"],T={key:1,class:"scan-line"},H={class:"bottom-controls"},J={class:"tips"},N=A(e({__name:"AutoScanCamera",props:{active:{type:Boolean}},emits:["detected","error","close"],setup(e,{emit:A}){const I=e,S=A,{t:x}=t(),C=n(null),k=n(null),N=n(!1),z=n(!1),L=n(x("scanIngredients.autoScan.status.init","Initializing HD Camera...")),F=n("/hints/hints1.png");let E=null,B=null;const V=a(()=>({"status-scanning":N.value&&!z.value,"status-detected":z.value,"status-idle":!N.value})),W=["ingredients","ingredient","æˆåˆ†","æˆä»½","é…æ–™","åŽŸæ–™","ææ–™","å…§å®¹ç‰©","å†…å®¹ç‰©"];async function initCamera(){if(!E){console.log("ðŸ“¸ [AutoScan] Requesting HD camera access..."),L.value=x("scanIngredients.autoScan.status.connecting","Connecting HD Camera...");try{E=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080},focusMode:"continuous"},audio:!1}),C.value&&(C.value.srcObject=E,C.value.setAttribute("autoplay",""),C.value.setAttribute("muted",""),C.value.setAttribute("playsinline",""),await C.value.play(),console.log("âœ… [AutoScan] Video started: ".concat(C.value.videoWidth,"x").concat(C.value.videoHeight)),L.value=x("scanIngredients.autoScan.status.searching","Searching for ingredients..."),N.value=!0,async function startAnalysis(){if(B)return;B=setInterval(async()=>{var e,t;if(!N.value||z.value||!C.value||!k.value)return;const n=C.value,a=k.value,o=a.getContext("2d");if(o){a.width=1024,a.height=1024/n.videoWidth*n.videoHeight,o.drawImage(n,0,0,a.width,a.height);try{console.log("ðŸ” [AutoScan] AI Checking..."),L.value=x("scanIngredients.autoScan.status.scanning","AI Scanning...");const n=a.toDataURL("image/jpeg",.8).split(",")[1],o=await fetch("".concat("https://svmlwnzmheiishkdwafk.supabase.co","/functions/v1/google-ocr"),{method:"POST",headers:{Authorization:"Bearer ".concat("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2bWx3bnptaGVpaXNoa2R3YWZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNDk3OTUsImV4cCI6MjA2ODkyNTc5NX0.DQ5Xuq0F2x_5EJAMzUQreAWY9ecyTCd3mORl-Fo0Ydo"),"Content-Type":"application/json"},body:JSON.stringify({imageBase64:n,includeAnnotations:!0})}),s=await o.json();console.log("ðŸ“¦ [AutoScan] OCR Response keys:",JSON.stringify(Object.keys(s)));const i=(s.text||"").toLowerCase(),c=W.find(e=>i.includes(e));if(c){console.log("ðŸŽ¯ [AutoScan] MATCH:",c);let n=null,o=s.textAnnotations||(null==(t=null==(e=s.responses)?void 0:e[0])?void 0:t.textAnnotations);if(!o&&s.words){console.log('ðŸ’¡ [AutoScan] mapping "words" to annotations format');const e=s.words[0];console.log("ðŸ“¦ [AutoScan] Sample word:",JSON.stringify(e));const t=s.words.map(e=>{let t=[];const n=e.boundingPoly||e.boundingBox;return n&&Array.isArray(n.vertices)?t=n.vertices:n&&"number"==typeof n.x?t=[{x:n.x,y:n.y},{x:n.x+n.w,y:n.y},{x:n.x+n.w,y:n.y+n.h},{x:n.x,y:n.y+n.h}]:Array.isArray(e.vertices)&&(t=e.vertices),{description:e.text||e.description||e.word||"",boundingPoly:{vertices:t}}});o=[{description:s.text||"",boundingPoly:{vertices:[]}},...t]}o?n=function calculateROI(e,t,n,a){var o,s;try{console.log("ðŸ” [AutoScan] Attempting ROI for:",t,"on ".concat(n,"x").concat(a));let i=e.find((e,n)=>n>0&&e.description&&e.description.toLowerCase().includes(t.toLowerCase()));if(!i||!i.boundingPoly){let n="",a=[];for(let t=1;t<e.length;t++){const o=e[t].description||"";n+=o;for(let n=0;n<o.length;n++)a.push(e[t])}const o=n.toLowerCase().indexOf(t.toLowerCase());-1!==o&&a[o]&&(i=a[o],console.log("ðŸ’¡ [AutoScan] Fuzzy match successful for '".concat(t,"'. Mapped to block:"),i.description))}if(!i||!i.boundingPoly)return console.warn("âš ï¸ [AutoScan] Keyword match failed for '".concat(t,"' in textAnnotations blocks (total blocks: ").concat(e.length,")")),(null==(s=null==(o=e[0])?void 0:o.description)?void 0:s.toLowerCase().includes(t.toLowerCase()))&&console.log("ðŸ’¡ [AutoScan] Keyword found in block 0 only, using full image coordinates"),null;console.log("ðŸŽ¯ [AutoScan] Found target block:",i.description);const c=i.boundingPoly.vertices;let l=0,r=0;c.length>0&&(void 0!==c[0].x?(l=Math.min(...c.map(e=>{var t;return null!=(t=e.x)?t:0})),r=Math.min(...c.map(e=>{var t;return null!=(t=e.y)?t:0}))):"number"==typeof c[0]&&(l=c[0],r=c[1]));let u=l,d=l,v=r,g=r;for(let t=1;t<e.length;t++){const n=e[t].boundingPoly;if(!n||!n.vertices||0===n.vertices.length)continue;let a=0,o=0,s=0,i=0;const c=n.vertices;void 0!==c[0].x?(a=Math.min(...c.map(e=>{var t;return null!=(t=e.x)?t:0})),o=Math.max(...c.map(e=>{var t;return null!=(t=e.x)?t:0})),s=Math.min(...c.map(e=>{var t;return null!=(t=e.y)?t:0})),i=Math.max(...c.map(e=>{var t;return null!=(t=e.y)?t:0}))):"number"==typeof c[0]&&(c.length>=8?(a=Math.min(c[0],c[2],c[4],c[6]),o=Math.max(c[0],c[2],c[4],c[6]),s=Math.min(c[1],c[3],c[5],c[7]),i=Math.max(c[1],c[3],c[5],c[7])):(a=c[0],o=c[0],s=c[1],i=c[1])),i>=r-50&&(u=Math.min(u,a),d=Math.max(d,o),v=Math.min(v,s),g=Math.max(g,i))}const m=.05*n,h=.05*a;u=Math.max(0,u-m),v=Math.max(0,v-h),d=Math.min(n,d+m),g=Math.min(a,g+h);const p=u/n*100,y=v/a*100;let f=(d-u)/n*100,w=(g-v)/a*100;p+f>100&&(f=100-p),y+w>100&&(w=100-y);const b={left:p,top:y,width:f,height:w};return console.log("ðŸ“ [AutoScan] Dynamic text-bounded ROI:",b),b}catch(i){return console.error("âŒ [AutoScan] ROI calculation failed",i),null}}(o,c,a.width,a.height):console.warn("âš ï¸ [AutoScan] No annotations found for ROI. Keys:",Object.keys(s)),async function handleDetection(e=null){z.value=!0,L.value=x("scanIngredients.autoScan.status.found","Ingredients Found! Focusing..."),N.value=!1;try{await w.impact({style:b.Heavy}),setTimeout(async()=>{await w.impact({style:b.Heavy})},150)}catch(t){console.warn("âš ï¸ [AutoScan] Haptics failed",t)}if(await new Promise(e=>setTimeout(e,600)),C.value&&E){let n=null;try{const e=E.getVideoTracks()[0];if("ImageCapture"in window&&e){const t=new window.ImageCapture(e);n=await t.takePhoto()}}catch(t){console.warn("âš ï¸ [AutoScan] ImageCapture failed",t)}if(!n){const e=document.createElement("canvas");e.width=C.value.videoWidth,e.height=C.value.videoHeight;const t=e.getContext("2d");t&&(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(C.value,0,0),n=await new Promise(t=>e.toBlob(t,"image/jpeg",1)))}n&&S("detected",{blob:n,roi:e})}}(n)}else console.log("â³ [AutoScan] Ingredients not detected yet..."),L.value=x("scanIngredients.autoScan.status.notFound","Ingredients not found, keep holding...")}catch(s){console.warn("âš ï¸ [AutoScan] AI Analysis failed",s)}}},3500)}())}catch(e){console.error("âŒ [AutoScan] Camera access failed:",e),S("error","Could not access camera. Please check permissions.")}}}function stopCamera(){E&&(E.getTracks().forEach(e=>e.stop()),E=null),B&&(clearInterval(B),B=null),N.value=!1}return o(()=>I.active,e=>{e?initCamera():stopCamera()}),s(()=>{I.active&&initCamera();const e=Math.floor(5*Math.random())+1;F.value="/hints/hints".concat(e,".png")}),i(()=>{stopCamera()}),(e,t)=>(l(),c("div",M,[r("div",O,[r("video",{ref_key:"videoRef",ref:C,autoplay:"",playsinline:"",muted:"",class:"camera-preview"},null,512)]),r("div",R,[r("div",D,[r("span",P,"âœ¨ "+u(e.$t("scanIngredients.autoScan.title","Auto Scanner")),1),r("button",{class:"close-btn",onClick:t[0]||(t[0]=t=>e.$emit("close"))},[d(v(m),{icon:v(g)},null,8,["icon"])])]),r("div",_,[r("div",{class:h(["scan-area",{detected:z.value}])},[t[1]||(t[1]=r("div",{class:"corner top-left"},null,-1)),t[2]||(t[2]=r("div",{class:"corner top-right"},null,-1)),t[3]||(t[3]=r("div",{class:"corner bottom-left"},null,-1)),t[4]||(t[4]=r("div",{class:"corner bottom-right"},null,-1)),z.value?p("",!0):(l(),c("img",{key:0,src:F.value,class:"hint-overlay",alt:"Hint overlay"},null,8,j)),N.value?(l(),c("div",T)):p("",!0)],2)]),r("div",H,[r("div",{class:h(["status-badge",V.value])},[N.value&&!z.value?(l(),y(v(f),{key:0,name:"lines-small"})):p("",!0),r("span",null,u(L.value),1)],2),r("div",J,u(e.$t("scanIngredients.autoScan.hint","Position ingredients inside the frame")),1)])]),r("canvas",{ref_key:"canvasRef",ref:k,style:{display:"none"}},null,512)]))}}),[["__scopeId","data-v-a3ae227d"]]),z=A(e({__name:"AutoScanView",setup(e){const t=S(),{setResult:a}=k(),o=n("");function onDetected(e){a(e),t.back()}function onClose(){t.back()}function onError(e){o.value=e,setTimeout(()=>t.back(),2e3)}return(e,t)=>(l(),y(v(C),null,{default:I(()=>[d(N,{active:"",onDetected:onDetected,onClose:onClose,onError:onError}),d(v(x),{"is-open":!!o.value,message:o.value,duration:2e3,color:"danger",onDidDismiss:t[0]||(t[0]=e=>o.value="")},null,8,["is-open","message"])]),_:1}))}}),[["__scopeId","data-v-bce66075"]]);export{z as default};
