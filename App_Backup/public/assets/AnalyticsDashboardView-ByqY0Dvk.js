import{d as l,r as e,a6 as a,o as t,aB as u,B as s,c as n,w as o,u as i,s as r,b as c,e as d,O as v,ad as _,aM as f,S as y,D as p,N as h,ai as m,aj as g,n as b,p as k,aq as w,ar as A,G as M,E as U,t as x,i as C,l as D,cB as S,al as V,j as R,k as T,H as q,J as L,ag as H,F as W,y as j,_ as B}from"./index-D9IhqqAc.js";import{C as N,p as z,a as E,b as I,B as O,d as P,P as F,c as J,L as G,e as K,f as Q}from"./index-B4QOs9aT.js";import"./html5-qrcode-D_4nuB1t.js";const X=["innerHTML"],Y={class:"chart-container"},Z={key:0,style:{"text-align":"center","margin-top":"10px"}},$={class:"chart-container"},ll={key:0,style:{"text-align":"center","margin-top":"10px"}},el={class:"chart-container"},al={key:0,style:{"text-align":"center","margin-top":"10px"}},tl={class:"chart-container"},ul={key:0,style:{"text-align":"center","margin-top":"10px"}},sl={key:0,style:{"text-align":"center","margin-top":"10px"}},nl=B(l({__name:"AnalyticsDashboardView",setup(l){N.register(z,E,I,O,P,F,J,G,K);const B=s(),nl=e(0),ol=e(0),il=e([]),rl=e([]),cl=e([]),dl=e([]),vl=e(!1),_l=e(!1),fl=e(!1),yl=e(!1),pl=e(!1),hl=e([]),ml=a(()=>{const l=vl.value?il.value:il.value.slice(0,5);return{labels:l.map(l=>l.activity_type),datasets:[{label:"Usage",data:l.map(l=>l.count),backgroundColor:"rgba(255,159,64,0.8)"}]}}),gl=a(()=>{const l=_l.value?rl.value:rl.value.slice(0,5);return{labels:l.map(l=>function shortName(l,e=20){return l?l.length>e?l.slice(0,e)+"â€¦":l:"(Unnamed)"}(l.product_name)),datasets:[{label:"Views",data:l.map(l=>l.count),backgroundColor:"#2ecc71"}]}}),bl=a(()=>{const l=fl.value?cl.value:cl.value.slice(0,5);return{labels:l.map(l=>l.name||l.place_name||"(Unknown)"),datasets:[{label:"Views",data:l.map(l=>Number(l.count)),backgroundColor:"#3498db"}]}}),kl=e(null),wl={responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{maxRotation:30,minRotation:0,autoSkip:!0,color:"#ccc"}},y:{ticks:{color:"#ccc"}}}},Al={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#ccc"}}},scales:{x:{ticks:{color:"#ccc"}},y:{ticks:{color:"#ccc"}}}},Ml=a(()=>"daily"===Dl.value?"Today's Activity":"weekly"===Dl.value?"This Week's Activity":"monthly"===Dl.value?"This Month's Activity":"Activity"),Ul=a(()=>"daily"===Dl.value?"Today":"weekly"===Dl.value?"This Week":"monthly"===Dl.value?"This Month":""),xl=a(()=>"daily"===Dl.value?"DAU":"weekly"===Dl.value?"WAU":"monthly"===Dl.value?"MAU":"DAU"),Cl=a(()=>"daily"===Dl.value?"<b>DAU</b> = Daily Active Users<br>Unique users who opened the app today.":"weekly"===Dl.value?"<b>WAU</b> = Weekly Active Users<br>Unique users who opened the app this week.":"monthly"===Dl.value?"<b>MAU</b> = Monthly Active Users<br>Unique users who opened the app this month.":""),Dl=e("daily");async function fetchAnalytics(){const l=function resolveDateRange(){const l=(new Date).toISOString(),start=new Date;if("daily"===Dl.value)start.setHours(0,0,0,0);else if("weekly"===Dl.value){const l=start.getDay(),e=0===l?6:l-1;start.setDate(start.getDate()-e),start.setHours(0,0,0,0)}else"monthly"===Dl.value&&(start.setDate(1),start.setHours(0,0,0,0));return{start:start.toISOString(),end:l}}();if(!l)return;const{start:start,end:e}=l,{data:a,error:t}=await r.rpc("analytics_full_range",{start_ts:start,end_ts:e});if(t)return void console.error("Analytics RPC Error:",t);nl.value=a.summary.unique_users,ol.value=a.summary.total_events,il.value=a.top_features||[],rl.value=a.top_products||[],cl.value=a.top_locations||[];const u=Array(24).fill(0),s=a.summary.hourly||{};Object.entries(s).forEach(([l,e])=>{u[Number(l)]=Number(e)});const n=function loess(l,e=.25){const a=[],t=l.length;for(let u=0;u<t;u++){const s=[];for(let l=0;l<t;l++){const a=Math.abs(l-u),n=Math.exp(-a*a/(2*e*e*t*t));s.push(n)}let n=0,o=0;for(let e=0;e<t;e++)n+=s[e]*l[e],o+=s[e];a.push(o?n/o:0)}return a}(u,.22);kl.value={labels:[...Array(24).keys()].map(l=>"".concat(l,":00")),datasets:[{type:"bar",label:"Events (Bar)",data:u,backgroundColor:"rgba(255,159,64,0.6)",borderRadius:4,order:0},{type:"line",label:"Trend",data:n,borderColor:"#bb86fc",backgroundColor:"rgba(187,134,252,0.15)",fill:!1,tension:.6,cubicInterpolationMode:"monotone",pointRadius:0,borderWidth:3,order:1}]};const{data:o}=await r.from("activity_log").select("id, activity_detail").eq("activity_type","search_query").gte("created_at",start).lte("created_at",e).order("created_at",{ascending:!1}).limit(10);dl.value=(o||[]).map(l=>({...l,activity_detail:"string"==typeof l.activity_detail?JSON.parse(l.activity_detail):l.activity_detail}));const{data:i}=await r.rpc("analytics_user_behavior_clusters",{start_ts:start,end_ts:e});hl.value=(i||[]).slice(0,10),vl.value=!1,_l.value=!1,fl.value=!1,yl.value=!1}return t(()=>{u.value?fetchAnalytics():B.replace("/profile")}),(l,e)=>(c(),n(i(j),null,{default:o(()=>[d(i(v),null,{default:o(()=>[d(_,{title:"Analytics Dashboard",icon:i(f),showBack:!0},null,8,["icon"])]),_:1}),d(i(y),{class:"ion-padding"},{default:o(()=>[d(i(p),null,{default:o(()=>[d(i(h),null,{default:o(()=>[d(i(m),null,{default:o(()=>[d(i(g),null,{default:o(()=>[d(i(b),null,{default:o(()=>e[7]||(e[7]=[k("Range",-1)])),_:1,__:[7]}),d(i(w),{modelValue:Dl.value,"onUpdate:modelValue":e[0]||(e[0]=l=>Dl.value=l),interface:"popover",placeholder:"Select Range",onIonChange:e[1]||(e[1]=l=>function onRangeChange(l){Dl.value=l.detail.value,fetchAnalytics()}(l))},{default:o(()=>[d(i(A),{value:"daily"},{default:o(()=>e[8]||(e[8]=[k("Daily",-1)])),_:1,__:[8]}),d(i(A),{value:"weekly"},{default:o(()=>e[9]||(e[9]=[k("Weekly",-1)])),_:1,__:[9]}),d(i(A),{value:"monthly"},{default:o(()=>e[10]||(e[10]=[k("Monthly",-1)])),_:1,__:[10]})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>[k(x(Ml.value),1)]),_:1})]),_:1}),d(i(h),null,{default:o(()=>[C("p",null,[C("strong",null,x(xl.value),1),d(i(D),{icon:i(S),id:"dau-info",color:"medium",style:{"margin-left":"6px",cursor:"help"}},null,8,["icon"]),d(i(V),{trigger:"dau-info","trigger-action":"click"},{default:o(()=>[d(i(y),{class:"ion-padding"},{default:o(()=>[C("span",{innerHTML:Cl.value},null,8,X)]),_:1})]),_:1}),k(" : "+x(nl.value),1)]),C("p",null,[e[11]||(e[11]=C("strong",null,"Total Events:",-1)),k(" "+x(ol.value),1)])]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>e[12]||(e[12]=[k("ðŸ”¥ Most Used Features",-1)])),_:1,__:[12]})]),_:1}),d(i(h),null,{default:o(()=>[C("div",Y,[ml.value&&ml.value.labels.length?(c(),n(i(Q),{key:0,data:ml.value,options:wl},null,8,["data"])):T("",!0)]),d(i(m),{class:"ion-margin-top"},{default:o(()=>[(c(!0),R(q,null,L(vl.value?il.value:il.value.slice(0,5),(l,e)=>(c(),n(i(g),{key:l.activity_type+"-"+e},{default:o(()=>[d(i(b),null,{default:o(()=>[k(x(l.activity_type),1)]),_:2},1024),d(i(H),{slot:"end",color:"primary"},{default:o(()=>[k(x(l.count),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),il.value.length>5?(c(),R("div",Z,[d(i(W),{fill:"clear",color:"carrot",size:"small",onClick:e[2]||(e[2]=l=>vl.value=!vl.value)},{default:o(()=>[k(x(vl.value?"Show Less":"View More"),1)]),_:1})])):T("",!0)]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>e[13]||(e[13]=[k("ðŸ¥˜ Most Viewed Products",-1)])),_:1,__:[13]})]),_:1}),d(i(h),null,{default:o(()=>[C("div",$,[gl.value&&gl.value.labels&&gl.value.labels.length?(c(),n(i(Q),{key:0,data:gl.value,options:wl},null,8,["data"])):T("",!0)]),d(i(m),{class:"ion-margin-top"},{default:o(()=>[(c(!0),R(q,null,L(_l.value?rl.value:rl.value.slice(0,5),(l,e)=>(c(),n(i(g),{key:l.barcode+"-"+e},{default:o(()=>[d(i(b),null,{default:o(()=>[k(x(l.product_name),1)]),_:2},1024),d(i(H),{slot:"end",color:"success"},{default:o(()=>[k(x(l.count),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),rl.value.length>5?(c(),R("div",ll,[d(i(W),{fill:"clear",color:"carrot",size:"small",onClick:e[3]||(e[3]=l=>_l.value=!_l.value)},{default:o(()=>[k(x(_l.value?"Show Less":"View More"),1)]),_:1})])):T("",!0)]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>e[14]||(e[14]=[k("ðŸ•Œ Most Viewed Locations",-1)])),_:1,__:[14]})]),_:1}),d(i(h),null,{default:o(()=>[C("div",el,[bl.value&&bl.value.labels.length>0?(c(),n(i(Q),{key:0,data:bl.value,options:wl},null,8,["data"])):T("",!0)]),d(i(m),{class:"ion-margin-top"},{default:o(()=>[(c(!0),R(q,null,L(fl.value?cl.value:cl.value.slice(0,5),(l,e)=>(c(),n(i(g),{key:l.place_id+"-"+e},{default:o(()=>[d(i(b),null,{default:o(()=>[k(x(l.place_name),1)]),_:2},1024),d(i(H),{slot:"end",color:"tertiary"},{default:o(()=>[k(x(l.count),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),cl.value.length>5?(c(),R("div",al,[d(i(W),{fill:"clear",color:"carrot",size:"small",onClick:e[4]||(e[4]=l=>fl.value=!fl.value)},{default:o(()=>[k(x(fl.value?"Show Less":"View More"),1)]),_:1})])):T("",!0)]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>[k("â³ Activity by Hour ("+x(Ul.value)+")",1)]),_:1})]),_:1}),d(i(h),null,{default:o(()=>[C("div",tl,[kl.value?(c(),n(i(Q),{key:0,data:kl.value,options:Al},null,8,["data"])):T("",!0)])]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>e[15]||(e[15]=[k("ðŸ§­ Top User Paths",-1)])),_:1,__:[15]})]),_:1}),d(i(h),null,{default:o(()=>[d(i(m),null,{default:o(()=>[(c(!0),R(q,null,L(pl.value?hl.value:hl.value.slice(0,5),(l,a)=>(c(),n(i(g),{key:l.path+"-"+a},{default:o(()=>[d(i(b),null,{default:o(()=>[C("strong",null,x(l.path),1),e[16]||(e[16]=C("br",null,null,-1)),C("small",null,x(l.steps)+" steps",1)]),_:2,__:[16]},1024),d(i(H),{slot:"end",color:"warning"},{default:o(()=>[k(x(l.users)+" users ",1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),hl.value.length>5?(c(),R("div",ul,[d(i(W),{fill:"clear",color:"carrot",size:"small",onClick:e[5]||(e[5]=l=>pl.value=!pl.value)},{default:o(()=>[k(x(pl.value?"Show Less":"View More"),1)]),_:1})])):T("",!0)]),_:1})]),_:1}),d(i(p),null,{default:o(()=>[d(i(M),null,{default:o(()=>[d(i(U),null,{default:o(()=>e[17]||(e[17]=[k("ðŸ” Recent Searches",-1)])),_:1,__:[17]})]),_:1}),d(i(h),null,{default:o(()=>[d(i(m),null,{default:o(()=>[(c(!0),R(q,null,L(yl.value?dl.value:dl.value.slice(0,5),l=>(c(),n(i(g),{key:l.id},{default:o(()=>[d(i(b),null,{default:o(()=>{var e;return[k(x((null==(e=l.activity_detail)?void 0:e.query)||"-"),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1}),dl.value.length>5?(c(),R("div",sl,[d(i(W),{fill:"clear",color:"carrot",size:"small",onClick:e[6]||(e[6]=l=>yl.value=!yl.value)},{default:o(()=>[k(x(yl.value?"Show Less":"View More"),1)]),_:1})])):T("",!0)]),_:1})]),_:1})]),_:1})]),_:1}))}}),[["__scopeId","data-v-0715dc45"]]);export{nl as default};
