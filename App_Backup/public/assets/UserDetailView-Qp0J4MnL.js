import{d as e,a2 as a,a5 as l,bm as t,r as n,o as u,aZ as r,a$ as s,c,w as o,u as i,s as _,b as d,e as p,O as f,ad as v,aM as m,S as g,k as y,D as k,aj as w,ak as h,j as b,n as U,i as x,t as N,N as S,G as D,E as O,p as A,ai as L,aK as P,H as V,J as C,bh as F,cf as H,cg as I,y as j,_ as B}from"./index-D9IhqqAc.js";import"./html5-qrcode-D_4nuB1t.js";const M=["src"],R={key:1,class:"avatar-placeholder"},T={class:"stats-row"},q={class:"stat-item"},E={class:"stat-item"},G={class:"stats-row"},J={class:"stat-item"},Y={class:"stat-item"},K=["src"],Z={class:"activity-time"},$=["src"],z={class:"activity-time"},Q=["src"],W={class:"activity-time"},X={class:"activity-title"},ee={class:"activity-meta"},ae={key:0},le={class:"activity-time"},te=B(e({__name:"UserDetailView",setup(e){a.extend(l);const B=t().params.id,te=n(null),ne=n(null),ue=n([]),re=n(!1),se=n(!1),ce=n([]),oe=n([]),ie=n([]);const fromNow=e=>e?a(e).fromNow():"Never",_e=n(null);function getNationality(e){if(!e)return null;const a=r.value.find(a=>a.cca2===e);return a?{name:a.name.common,flag:a.flags.png}:null}function describeActivity(e){var a,l,t,n,u,r,s,c,o,i,_,d,p,f,v,m,g,y,k,w,h;const b=function parseDetail(e){if(!e)return{};if("string"==typeof e)try{return JSON.parse(e)}catch(a){return{}}return e}(e.activity_detail);switch(e.activity_type){case"home_page_open":return"Opened Home page";case"home_scan_ingredient":return"Opened ingredient scanner from Home";case"home_viewmore_products":return"Viewed more products on Home";case"home_open_locations":return"Opened locations from Home";case"home_leaderboard_profile":return"Viewed leaderboard profile: ".concat(null!=(a=b.display_name)?a:"Unknown user");case"explore_page_open":return"Opened Explore page";case"explore_center_user":return"Centered map to current location";case"explore_filter_category":return"Filtered category: ".concat(null!=(l=b.category_name)?l:"Unknown category");case"explore_marker_click":return"Clicked map marker: ".concat(null!=(t=b.name)?t:"Unknown place"," (").concat(null!=(n=b.type)?n:"Unknown",")");case"explore_place_card_click":return"Opened place card: ".concat(null!=(u=b.name)?u:"Unknown place"," (").concat(null!=(r=b.type)?r:"Unknown",")");case"explore_place_detail_open":return"Opened place details: ".concat(null!=(s=b.name)?s:"Unknown place");case"explore_place_detail_view":return"Viewed place details: ".concat(null!=(c=b.name)?c:"Unknown place");case"explore_detail_open_image":return"Viewed place image: ".concat(null!=(o=b.name)?o:"Unknown place");case"search_page_open":return"Opened Search page";case"search_product_click":return"Opened product: ".concat(null!=(i=b.product_name)?i:"Unknown product"," (").concat(null!=(_=b.status)?_:"Unknown",")");case"search_sort_change":return"Sort product by ".concat(null!=(d=b.sort)?d:"Unknown product");case"search_filter_status":return"Filter product by ".concat(null!=(p=b.status)?p:"Unknown product");case"search_filter_category":return"Filter product by ".concat(null!=(f=b.category_name)?f:"Unknown product");case"product_details_open":return"Viewed product: ".concat(null!=(v=b.product_name)?v:"Unknown product"," (").concat(null!=(m=b.status)?m:"Unknown",")");case"scan_ingredients_start":return"Started ingredient scan (".concat(null!=(g=b.source)?g:"unknown source",")");case"scan_ingredients_success":return"Scan result: ".concat(null!=(y=b.product_name)?y:"Unknown product"," ‚Ä¢ ").concat(b.auto_status," ‚Ä¢ ").concat(null!=(k=b.ingredient_count)?k:0," ingredients");case"scan_ingredients_error":return"Scan failed: ".concat(null!=(w=b.error)?w:"Unknown error");case"profile_page_open":return"Opened Profile page";case"social_link_click":return"Clicked social link (".concat(null!=(h=b.platform)?h:"unknown",")");default:return e.activity_type.replace(/_/g," ")}}async function fetchLogs(e=!1){e&&(ue.value=[],re.value=!1);const a=ue.value.length,{data:l,error:t}=await _.rpc("get_user_activity_logs",{p_user_id:B,p_limit:20,p_offset:a});t?console.error("‚ùå Failed to load activity logs",t):((!l||l.length<20)&&(re.value=!0),ue.value.push(...l))}async function loadMore(e){se.value||re.value||(se.value=!0,await fetchLogs(),se.value=!1),e.target.complete()}return u(async()=>{r.value.length||await s(),await async function fetchUser(){const{data:e}=await _.from("user_profiles").select("*").eq("id",B).single();te.value=e}(),await async function fetchSummary(){const{data:e}=await _.rpc("get_admin_user_summary",{p_user_id:B});ne.value=null==e?void 0:e.find(e=>e.user_id===B)}(),await async function fetchLastDevice(){var e;const{data:a,error:l}=await _.rpc("get_user_last_device",{p_user_id:B});l?console.error("‚ùå Failed to load device info",l):_e.value=null!=(e=null==a?void 0:a[0])?e:null}(),await async function fetchRecents(){var e,a,l;const[t,n,u]=await Promise.all([_.rpc("get_user_recent_searches",{p_user_id:B,p_limit:20}),_.rpc("get_user_recent_products",{p_user_id:B,p_limit:20}),_.rpc("get_user_recent_places",{p_user_id:B,p_limit:20})]);t.error||(ce.value=null!=(e=t.data)?e:[]),n.error||(oe.value=null!=(a=n.data)?a:[]),u.error||(ie.value=null!=(l=u.data)?l:[])}(),await fetchLogs(!0)}),(e,l)=>(d(),c(i(j),null,{default:o(()=>[p(i(f),null,{default:o(()=>[p(v,{title:"User Detail",icon:i(m),showBack:!0},null,8,["icon"])]),_:1}),p(i(g),{class:"ion-padding"},{default:o(()=>[te.value?(d(),c(i(k),{key:0},{default:o(()=>[p(i(w),{lines:"none"},{default:o(()=>[p(i(h),{slot:"start"},{default:o(()=>[te.value.avatar_url?(d(),b("img",{key:0,src:te.value.avatar_url},null,8,M)):(d(),b("div",R,"üë§"))]),_:1}),p(i(U),null,{default:o(()=>[x("h2",null,N(te.value.display_name||"Unknown User"),1),x("p",null,N(te.value.email),1)]),_:1})]),_:1})]),_:1})):y("",!0),ne.value?(d(),c(i(k),{key:1},{default:o(()=>[p(i(S),{class:"stats-card"},{default:o(()=>[x("div",T,[x("div",q,[x("strong",null,N(ne.value.total_activities),1),l[0]||(l[0]=x("span",null,"Activities",-1))]),x("div",E,[x("strong",null,N(fromNow(ne.value.last_active)),1),l[1]||(l[1]=x("span",null,"Last Active",-1))])]),x("div",G,[x("div",J,[x("strong",null,N(ne.value.points),1),l[2]||(l[2]=x("span",null,"Points",-1))]),x("div",Y,[x("strong",null,N(ne.value.donor_type),1),l[3]||(l[3]=x("span",null,"Account Type",-1))])])]),_:1})]),_:1})):y("",!0),te.value?(d(),c(i(k),{key:2},{default:o(()=>[p(i(D),null,{default:o(()=>[p(i(O),null,{default:o(()=>l[4]||(l[4]=[A("Profile Details",-1)])),_:1,__:[4]})]),_:1}),p(i(L),{lines:"none"},{default:o(()=>[p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[5]||(l[5]=[A("Date of Birth",-1)])),_:1,__:[5]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(te.value.date_of_birth||"‚Äî"),1)]),_:1})]),_:1}),p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[6]||(l[6]=[A("Nationality",-1)])),_:1,__:[6]}),getNationality(te.value.nationality)?(d(),c(i(P),{key:0,slot:"end"},{default:o(()=>{var e,a;return[x("img",{src:null==(e=getNationality(te.value.nationality))?void 0:e.flag,alt:"flag",style:{width:"20px",height:"14px","margin-right":"6px","vertical-align":"middle"}},null,8,K),A(" "+N(null==(a=getNationality(te.value.nationality))?void 0:a.name),1)]}),_:1})):(d(),c(i(P),{key:1,slot:"end"},{default:o(()=>l[7]||(l[7]=[A("‚Äî",-1)])),_:1,__:[7]}))]),_:1}),p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[8]||(l[8]=[A("Gender",-1)])),_:1,__:[8]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(te.value.gender||"‚Äî"),1)]),_:1})]),_:1}),p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[9]||(l[9]=[A("Bio",-1)])),_:1,__:[9]}),p(i(P),{slot:"end",class:"bio-text"},{default:o(()=>[A(N(te.value.bio||"No bio provided"),1)]),_:1})]),_:1}),p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[10]||(l[10]=[A("Public Leaderboard",-1)])),_:1,__:[10]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(te.value.public_leaderboard?"Yes":"No"),1)]),_:1})]),_:1}),p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[11]||(l[11]=[A("Profile Completed",-1)])),_:1,__:[11]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(te.value.profile_completed_notified?"Yes":"No"),1)]),_:1})]),_:1})]),_:1})]),_:1})):y("",!0),p(i(k),null,{default:o(()=>[p(i(D),null,{default:o(()=>[p(i(O),null,{default:o(()=>l[12]||(l[12]=[A("Technical Details",-1)])),_:1,__:[12]})]),_:1}),p(i(L),{lines:"none"},{default:o(()=>{var e,t,n,u,r,s,_;return[p(i(w),null,{default:o(()=>[p(i(U),null,{default:o(()=>l[13]||(l[13]=[A("User ID",-1)])),_:1,__:[13]}),p(i(P),{slot:"end",class:"mono"},{default:o(()=>[A(N(i(B)),1)]),_:1})]),_:1}),(null==(e=te.value)?void 0:e.created_at)?(d(),c(i(w),{key:0},{default:o(()=>[p(i(U),null,{default:o(()=>l[14]||(l[14]=[A("Account Created",-1)])),_:1,__:[14]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(new Date(te.value.created_at).toLocaleDateString()),1)]),_:1})]),_:1})):y("",!0),(null==(t=te.value)?void 0:t.created_at)?(d(),c(i(w),{key:1},{default:o(()=>[p(i(U),null,{default:o(()=>l[15]||(l[15]=[A("Member Since",-1)])),_:1,__:[15]}),p(i(P),{slot:"end"},{default:o(()=>{return[A(N((e=te.value.created_at,a(e).fromNow(!0)+" ago")),1)];var e}),_:1})]),_:1})):y("",!0),(null==(n=te.value)?void 0:n.last_sign_in_at)?(d(),c(i(w),{key:2},{default:o(()=>[p(i(U),null,{default:o(()=>l[16]||(l[16]=[A("Last Sign In (Auth)",-1)])),_:1,__:[16]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(fromNow(te.value.last_sign_in_at)),1)]),_:1})]),_:1})):y("",!0),(null==(u=_e.value)?void 0:u.last_scan_at)?(d(),c(i(w),{key:3},{default:o(()=>[p(i(U),null,{default:o(()=>l[17]||(l[17]=[A("Last Scan Activity",-1)])),_:1,__:[17]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(fromNow(_e.value.last_scan_at)),1)]),_:1})]),_:1})):y("",!0),(null==(r=_e.value)?void 0:r.platform)?(d(),c(i(w),{key:4},{default:o(()=>[p(i(U),null,{default:o(()=>l[18]||(l[18]=[A("Platform",-1)])),_:1,__:[18]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(_e.value.platform),1)]),_:1})]),_:1})):y("",!0),(null==(s=_e.value)?void 0:s.device_model)?(d(),c(i(w),{key:5},{default:o(()=>[p(i(U),null,{default:o(()=>l[19]||(l[19]=[A("Device",-1)])),_:1,__:[19]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(_e.value.device_model),1)]),_:1})]),_:1})):y("",!0),(null==(_=_e.value)?void 0:_.app_version)?(d(),c(i(w),{key:6},{default:o(()=>[p(i(U),null,{default:o(()=>l[20]||(l[20]=[A("App Version",-1)])),_:1,__:[20]}),p(i(P),{slot:"end"},{default:o(()=>[A(N(_e.value.app_version),1)]),_:1})]),_:1})):y("",!0)]}),_:1})]),_:1}),ce.value.length?(d(),c(i(k),{key:3},{default:o(()=>[p(i(D),null,{default:o(()=>[p(i(O),null,{default:o(()=>l[21]||(l[21]=[A("Recent Searches",-1)])),_:1,__:[21]})]),_:1}),p(i(L),{lines:"none"},{default:o(()=>[(d(!0),b(V,null,C(ce.value,(e,a)=>(d(),c(i(w),{key:a},{default:o(()=>[p(i(U),null,{default:o(()=>[x("strong",null,N(e.search_text),1),x("p",Z,N(fromNow(e.searched_at)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):y("",!0),oe.value.length?(d(),c(i(k),{key:4},{default:o(()=>[p(i(D),null,{default:o(()=>[p(i(O),null,{default:o(()=>l[22]||(l[22]=[A("Recent Products",-1)])),_:1,__:[22]})]),_:1}),p(i(L),{lines:"none"},{default:o(()=>[(d(!0),b(V,null,C(oe.value,(e,a)=>(d(),c(i(w),{key:a},{default:o(()=>[e.product_image?(d(),c(i(F),{key:0,slot:"start"},{default:o(()=>[x("img",{src:e.product_image},null,8,$)]),_:2},1024)):y("",!0),p(i(U),null,{default:o(()=>{var a;return[x("strong",null,N(null!=(a=e.product_name)?a:"Barcode: ".concat(e.product_id)),1),x("p",z,N(fromNow(e.viewed_at)),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):y("",!0),ie.value.length?(d(),c(i(k),{key:5},{default:o(()=>[p(i(D),null,{default:o(()=>[p(i(O),null,{default:o(()=>l[23]||(l[23]=[A("Recent Places",-1)])),_:1,__:[23]})]),_:1}),p(i(L),{lines:"none"},{default:o(()=>[(d(!0),b(V,null,C(ie.value,(e,a)=>(d(),c(i(w),{key:a},{default:o(()=>[e.place_image?(d(),c(i(F),{key:0,slot:"start"},{default:o(()=>[x("img",{src:e.place_image},null,8,Q)]),_:2},1024)):y("",!0),p(i(U),null,{default:o(()=>{var a;return[x("strong",null,N(null!=(a=e.place_name)?a:"Place #".concat(e.place_id)),1),x("p",W,N(fromNow(e.interacted_at)),1)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):y("",!0),p(i(k),null,{default:o(()=>[p(i(D),null,{default:o(()=>[p(i(O),null,{default:o(()=>l[24]||(l[24]=[A("Activity Timeline",-1)])),_:1,__:[24]})]),_:1}),p(i(L),null,{default:o(()=>[(d(!0),b(V,null,C(ue.value,e=>(d(),c(i(w),{key:e.id,lines:"full"},{default:o(()=>[p(i(U),null,{default:o(()=>[x("h3",X,N(describeActivity(e)),1),x("p",ee,[A(N(e.activity_group||"general")+" ",1),e.entity_type?(d(),b("span",ae," ‚Ä¢ "+N(e.entity_type)+" "+N(e.entity_id),1)):y("",!0)]),x("p",le,N(fromNow(e.created_at)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),p(i(H),{threshold:"100px",onIonInfinite:loadMore,disabled:re.value},{default:o(()=>[p(i(I),{"loading-spinner":"bubbles","loading-text":"Loading activity..."})]),_:1},8,["disabled"])]),_:1})]),_:1}))}}),[["__scopeId","data-v-42d35373"]]);export{te as default};
