import{d as e,r as a,A as l,a6 as t,a7 as i,o as r,a8 as n,c as s,w as o,u as c,s as u,b as d,e as v,O as p,ad as _,x as m,P as f,an as g,i as h,F as y,ao as w,p as k,t as $,l as b,ap as C,aq as z,ar as x,as as j,at as T,au as V,av as F,j as q,k as I,v as L,H as P,J as S,ah as A,L as D,n as N,$ as O,aw as B,S as R,D as U,W as H,N as J,ag as W,y as E,_ as G}from"./index-D9IhqqAc.js";import{B as K}from"./index-mXqEtQG2.js";import"./html5-qrcode-D_4nuB1t.js";const M={class:"toolbar-row"},Q={class:"filter-section"},X={class:"filter-title"},Y={class:"category-bar"},Z={class:"filter-title"},ee={class:"category-bar"},ae={key:0,class:"filter-clear-row"},le=["src","alt"],te={class:"trip-title"},ie={class:"trip-provider"},re={class:"chip-row"},ne={class:"trip-meta"},se={class:"trip-meta"},oe=G(e({__name:"TripListView",setup(e){const G=a(!0),oe=a(""),ce=a(!1),ue=a([]),de=a("recent"),{t:ve}=l(),pe=t(()=>"views"===de.value?ve("trip.sortViews"):ve("trip.sortRecent")),_e=a([{id:1,name:"trip.catCity",emoji:"ğŸ™ï¸"},{id:2,name:"trip.catNature",emoji:"ğŸŒ¿"},{id:3,name:"trip.catFamily",emoji:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"}]),me=a([]),fe=a([]),ge=a(!0);const he=a([]);const ye=t(()=>{const e=he.value.filter(e=>{var a;const l=e.title.toLowerCase().includes(oe.value.toLowerCase()),t=0===ue.value.length||e.categories.some(e=>_e.value.filter(e=>ue.value.includes(e.id)).map(e=>e.name).includes(e)),i=0===fe.value.length||(null==(a=e.trip_cities)?void 0:a.some(e=>fe.value.includes(e.cities.slug)));return l&&t&&i});return"views"===de.value?[...e].sort((e,a)=>{var l,t;return(null!=(l=a.view_count)?l:0)-(null!=(t=e.view_count)?t:0)}):[...e].sort((e,a)=>{var l,t;return new Date(null!=(l=a.created_at)?l:"").getTime()-new Date(null!=(t=e.created_at)?t:"").getTime()})});function clearFilters(){n.log("trip_filter_clear",{categories:ue.value,cities:fe.value}),ue.value=[],fe.value=[]}let we=null;function handleSearchInput(e){const a=e.target.value.trim();oe.value=a,we&&clearTimeout(we),a.length>1&&(we=window.setTimeout(()=>{n.log("trip_search",{query:a})},800))}return i(de,e=>{n.log("trip_sort_change",{sort_by:e})}),r(()=>{n.log("trip_page_open",{source:"main_navigation"}),async function fetchTrips(){G.value=!0;const{data:e,error:a}=await u.from("trips").select("\n        id,\n        title,\n        title_zh,\n        duration,\n        cover_url,\n        external_url,\n        created_at,\n        view_count,\n        provider:partners (\n          id,\n          name,\n          partner_tier\n        ),\n        trip_cities (\n          city_id,\n          cities:city_id (\n            id,\n            slug,\n            name,\n            name_zh,\n            emoji\n          )\n        )\n      ").eq("is_active",!0);if(a)return console.error("[Trips]",a),void(G.value=!1);he.value=(null!=e?e:[]).map(e=>({id:e.id,title:e.title,title_zh:e.title_zh,cover:e.cover_url,duration:e.duration,categories:[],external_url:e.external_url,provider:Array.isArray(e.provider)?e.provider[0]:e.provider,created_at:e.created_at,view_count:e.view_count,trip_cities:e.trip_cities||[]})),G.value=!1}(),async function fetchCities(){ge.value=!0;const{data:e,error:a}=await u.from("cities").select("id, slug, name, name_zh, emoji").order("sort_order",{ascending:!0});!a&&e&&(me.value=e),ge.value=!1}()}),(e,a)=>(d(),s(c(E),null,{default:o(()=>[v(c(p),null,{default:o(()=>[v(_,{title:e.$t("trip.title"),icon:c(m),showProfile:!0},null,8,["title","icon"]),v(c(f),{class:"toolbar-search"},{default:o(()=>[v(c(g),{modelValue:oe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>oe.value=e),placeholder:e.$t("trip.searchPlaceholder"),debounce:500,class:"rounded",onIonInput:handleSearchInput},null,8,["modelValue","placeholder"])]),_:1}),v(c(f),{class:"search-toolbar"},{default:o(()=>[h("div",M,[v(c(y),{fill:"clear",size:"small",class:"sort-button"},{default:o(()=>[v(c(w),{class:"toolbar-label ion-padding-horizontal"},{default:o(()=>[k($(pe.value),1)]),_:1}),v(c(b),{icon:c(C)},null,8,["icon"]),v(c(z),{modelValue:de.value,"onUpdate:modelValue":a[1]||(a[1]=e=>de.value=e),interface:"popover",class:"hidden-select","interface-options":{cssClass:"sort-popover"}},{default:o(()=>[v(c(x),{value:"recent"},{default:o(()=>[k($(e.$t("trip.sortRecent")),1)]),_:1}),v(c(x),{value:"views"},{default:o(()=>[k($(e.$t("trip.sortViews")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),v(c(y),{fill:"clear",size:"small",onClick:a[2]||(a[2]=e=>ce.value=!ce.value)},{default:o(()=>[v(c(w),{class:"toolbar-label ion-padding-horizontal"},{default:o(()=>[v(c(b),{icon:c(j),class:"icon-inline"},null,8,["icon"]),k(" "+$(e.$t("common.filters")),1)]),_:1}),v(c(b),{icon:ce.value?c(T):c(C)},null,8,["icon"])]),_:1})]),v(V,{name:"collapse"},{default:o(()=>[F(h("div",Q,[h("div",X,[v(c(b),{icon:c(L)},null,8,["icon"]),k(" "+$(e.$t("trip.categories")),1)]),h("div",Y,[(d(!0),q(P,null,S(_e.value,a=>(d(),s(c(A),{key:a.id,class:D(["category-chip",{active:ue.value.includes(a.id)}]),onClick:e=>function toggleCategory(e){const a=ue.value.indexOf(e);-1===a?(ue.value.push(e),n.log("trip_filter_category_add",{category_id:e})):(ue.value.splice(a,1),n.log("trip_filter_category_remove",{category_id:e}))}(a.id)},{default:o(()=>[v(c(N),null,{default:o(()=>[k($(a.emoji)+" "+$(e.$t(a.name)),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]),h("div",Z,[v(c(b),{icon:c(O)},null,8,["icon"]),k(" "+$(e.$t("trip.cities")),1)]),h("div",ee,[(d(!0),q(P,null,S(me.value,a=>(d(),s(c(A),{key:a.slug,class:D(["category-chip",{active:fe.value.includes(a.slug)}]),onClick:e=>function toggleCity(e){const a=fe.value.indexOf(e);-1===a?(fe.value.push(e),n.log("trip_filter_city_add",{city_slug:e})):(fe.value.splice(a,1),n.log("trip_filter_city_remove",{city_slug:e}))}(a.slug)},{default:o(()=>[v(c(N),null,{default:o(()=>[k($(a.emoji)+" "+$("zh-tw"===e.$i18n.locale?a.name_zh:a.name),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]),ue.value.length||fe.value.length?(d(),q("div",ae,[v(c(A),{class:"clear-chip",onClick:clearFilters},{default:o(()=>[k(" âœ• "+$(e.$t("common.clearFilters")),1)]),_:1})])):I("",!0)],512),[[B,ce.value]])]),_:1})]),_:1})]),_:1}),v(c(R),{class:"ion-padding"},{default:o(()=>[G.value?(d(),q(P,{key:0},S(4,e=>v(c(U),{key:"skeleton-"+e},{default:o(()=>[v(c(H),{animated:"",style:{width:"100%",height:"140px","border-radius":"12px"}}),v(c(H),{animated:"",style:{width:"70%",height:"16px",margin:"10px"}})]),_:2},1024)),64)):0===ye.value.length?(d(),s(c(U),{key:1},{default:o(()=>[v(c(J),null,{default:o(()=>[k(" ğŸ§­ "+$(e.$t("trip.noTripsFound")),1)]),_:1})]),_:1})):(d(!0),q(P,{key:2},S(ye.value,a=>(d(),s(c(U),{key:a.id,class:"trip-card",onClick:e=>async function openTrip(e){var a,l,t;n.log("trip_click",{trip_id:e.id,trip_title:e.title,provider_id:null==(a=e.provider)?void 0:a.id,provider_name:null==(l=e.provider)?void 0:l.name,provider_tier:null==(t=e.provider)?void 0:t.partner_tier,current_sort:de.value,active_categories:ue.value,active_cities:fe.value,search_query:oe.value||null}),await u.rpc("increment_trip_view",{p_trip_id:e.id}),await K.open({url:e.external_url,windowName:"_self",toolbarColor:"#e67e22",presentationStyle:"fullscreen"})}(a)},{default:o(()=>{var l;return["gold"===(null==(l=a.provider)?void 0:l.partner_tier)?(d(),s(c(W),{key:0,color:"warning",class:"partner-badge"},{default:o(()=>[k($(e.$t("partner.goldPartner")),1)]),_:1})):I("",!0),h("img",{src:a.cover,alt:a.title,class:"trip-cover"},null,8,le),v(c(J),null,{default:o(()=>{var l,t,i;return[h("h3",te,$("zh-tw"===e.$i18n.locale&&a.title_zh||a.title),1),h("p",ie,[k($(e.$t("trip.providedBy"))+" ",1),h("strong",null,$(null==(l=a.provider)?void 0:l.name),1)]),h("div",re,[(d(!0),q(P,null,S(a.categories,e=>(d(),s(c(A),{key:e,color:"primary"},{default:o(()=>[k($(e),1)]),_:2},1024))),128))]),h("p",ne," ğŸ“ "+$((null!=(t=a.trip_cities)?t:[]).filter(e=>e.cities).map(a=>"zh-tw"===e.$i18n.locale?a.cities.name_zh:a.cities.name).join(" + "))+" Â· ğŸ•’ "+$(a.duration),1),h("p",se," ğŸ‘ï¸ "+$(null!=(i=a.view_count)?i:0)+" "+$(e.$t("common.views")),1)]}),_:2},1024)]}),_:2},1032,["onClick"]))),128))]),_:1})]),_:1}))}}),[["__scopeId","data-v-4e4d552e"]]);export{oe as default};
