import{a6 as e,r as i,s as a,am as t,a2 as r,a3 as n,a4 as d}from"./index-D9IhqqAc.js";r.extend(n),r.extend(d);const c=i([{id:"open_app",label:"Opening App",required:1,current:0,points:5,completed:!1,icon:"home-outline"},{id:"scan_ingredients",label:"Scan Ingredients",required:5,current:0,points:10,completed:!1,icon:"scan-outline"},{id:"scan_barcode",label:"Scan Barcode",required:5,current:0,points:10,completed:!1,icon:"barcode-outline"},{id:"find_muslim_friendly",label:"Find Muslim-friendly product",required:3,current:0,points:10,completed:!1,icon:"heart-outline"},{id:"view_place_details",label:"Check location details",required:1,current:0,points:5,completed:!1,icon:"location-outline"},{id:"add_product",label:"Add A New Product",required:1,current:0,points:10,completed:!1,icon:"add-circle-outline"}]),s=i(!1),o=i(!1),l=i({}),u=new Set;function useDailyMissions(){const{awardAndCelebrate:i}=t(),n=e(()=>c.value.every(e=>e.completed));return{missions:c,loading:s,claimedBonus:o,allCompleted:n,fetchProgress:async function fetchProgress(){s.value=!0;try{const{data:{user:e}}=await a.auth.getUser();if(!e)return;const t=r().tz("Asia/Taipei").startOf("day").toISOString(),n=r().tz("Asia/Taipei").endOf("day").toISOString(),{data:d,error:s}=await a.from("activity_log").select("activity_type, activity_detail").eq("user_id",e.id).gte("created_at",t).lt("created_at",n);if(s)return void console.warn("[Missions] activity_log query error:",s.message);c.value.forEach(e=>{e.current=0,e.completed=!1}),null==d||d.forEach(e=>{let i=e.activity_detail;if("string"==typeof i)try{i=JSON.parse(i)}catch(a){i={}}switch(e.activity_type){case"scan_ingredients_success":const e=c.value.find(e=>"scan_ingredients"===e.id);if(e&&e.current<e.required&&e.current++,"Muslim-friendly"===(null==i?void 0:i.auto_status)){const e=c.value.find(e=>"find_muslim_friendly"===e.id);e&&e.current<e.required&&e.current++}break;case"explore_place_detail_open":const a=c.value.find(e=>"view_place_details"===e.id);a&&a.current<a.required&&a.current++;break;case"home_page_open":const t=c.value.find(e=>"open_app"===e.id);t&&t.current<t.required&&t.current++;break;case"barcode_scan_success":const r=c.value.find(e=>"scan_barcode"===e.id);r&&r.current<r.required&&r.current++;break;case"add_product_success":const n=c.value.find(e=>"add_product"===e.id);n&&n.current<n.required&&n.current++}});const{data:_,error:p}=await a.from("point_logs").select("action").eq("user_id",e.id).gte("created_at",t).lt("created_at",n),f=(null==_?void 0:_.map(e=>e.action))||[];c.value.forEach(e=>{const a="mission_".concat(e.id);l.value[e.id]=f.includes(a),"add_product"===e.id&&f.includes("add_product")&&(e.current=Math.max(e.current,1),l.value[e.id]=!0),e.current>=e.required&&(e.completed=!0,l.value[e.id]||u.has(e.id)||"add_product"===e.id||(console.log("[Missions] Awarding points for: ".concat(a)),u.add(e.id),i(a).finally(()=>{setTimeout(()=>{u.delete(e.id)},5e3)}),l.value[e.id]=!0))}),o.value=f.includes("daily_mission_bonus")}catch(e){console.error("Error fetching mission progress:",e)}finally{s.value=!1}},checkAndAwardBonus:async function checkAndAwardBonus(){if(n.value&&!o.value&&!u.has("daily_bonus")){const{data:{user:e}}=await a.auth.getUser();if(!e)return;console.log("[Missions] Awarding daily bonus..."),u.add("daily_bonus"),await i("daily_mission_bonus").finally(()=>{setTimeout(()=>{u.delete("daily_bonus")},5e3)}),o.value=!0}}}}export{useDailyMissions as u};
